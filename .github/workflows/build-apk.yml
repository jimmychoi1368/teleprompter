# =============================================================================
# GitHub Actions - è‡ªåŠ¨æ‰“åŒ… Android APKï¼ˆç»ˆæžè§£å†³æ–¹æ¡ˆï¼‰
# =============================================================================
# ã€é‡è¦å£°æ˜Žã€‘æœ¬é…ç½®æ–‡ä»¶ä»…å±žäºŽã€Œteleprompterã€ä»“åº“ï¼
# ä¸ŽçŽ°æœ‰ç½‘ç«™ä»“åº“æ— ä»»ä½•ä»£ç /é…ç½®äº¤é›†ï¼Œæ— å†²çªé£Žé™©ï¼
#
# æŠ€æœ¯æ ˆï¼šKivy + Vosk + Buildozer
# ä½¿ç”¨ï¼šandroid-actions/setup-android è‡ªåŠ¨é…ç½®SDK/è®¸å¯/å·¥å…·
#
# è§¦å‘æ¡ä»¶ï¼š
# - æŽ¨é€åˆ°mainåˆ†æ”¯
# - æ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰
#
# è¾“å‡ºï¼šAndroid APKæ–‡ä»¶ï¼ˆARM64æž¶æž„ï¼‰
# =============================================================================

name: Build Android APK

on:
  # æŽ¨é€åˆ°mainåˆ†æ”¯æ—¶è‡ªåŠ¨æž„å»º
  push:
    branches:
      - main
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘æž„å»º
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'Enable debug mode'
        required: false
        default: 'false'

# =============================================================================
# å…¨å±€çŽ¯å¢ƒå˜é‡ - ç»Ÿä¸€Android SDKè·¯å¾„ï¼Œè§£å†³è·¯å¾„ä¸ç»Ÿä¸€é—®é¢˜
# =============================================================================
env:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_HOME: /usr/local/lib/android/sdk
  ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/25.2.9519653

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
      # =========================================
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      # ä½œç”¨ï¼šä»ŽGitHubä»“åº“æ‹‰å–teleprompteré¡¹ç›®ä»£ç 
      # =========================================
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      # =========================================
      # æ­¥éª¤2: è®¾ç½®JavaçŽ¯å¢ƒ
      # ä½œç”¨ï¼šå®‰è£…JDK 17ï¼ŒAndroidæ‰“åŒ…å¿…éœ€
      # =========================================
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      # =========================================
      # æ­¥éª¤3: é…ç½®Android SDKï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼‰
      # ä½œç”¨ï¼šä½¿ç”¨android-actions/setup-androidè‡ªåŠ¨å®Œæˆï¼š
      #       - é…ç½®SDKè·¯å¾„
      #       - è‡ªåŠ¨æŽ¥å—æ‰€æœ‰SDKè®¸å¯ï¼ˆè§£å†³è®¸å¯é—®é¢˜ï¼‰
      #       - è®¾ç½®çŽ¯å¢ƒå˜é‡
      # =========================================
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
      
      # =========================================
      # æ­¥éª¤4: é¢„å†™SDKè®¸å¯æ–‡ä»¶ï¼ˆå…³é”®ä¿®å¤æ­¥éª¤ï¼‰
      # ä½œç”¨ï¼šæ‰‹åŠ¨å†™å…¥SDKè®¸å¯æ–‡ä»¶ï¼Œè§£å†³Buildozerå†…éƒ¨è°ƒç”¨
      #       sdkmanageræ—¶æ— æ³•ç»§æ‰¿è®¸å¯çŠ¶æ€çš„é—®é¢˜
      # ã€ä¿®æ”¹ä½ç½®ã€‘Setup Android SDKåŽæ–°å¢žæ­¤æ­¥éª¤
      # =========================================
      - name: Pre-Write SDK License File
        run: |
          echo "ðŸ“œ Pre-writing SDK license file..."
          mkdir -p $ANDROID_SDK_ROOT/licenses
          echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > $ANDROID_SDK_ROOT/licenses/android-sdk-license
          echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> $ANDROID_SDK_ROOT/licenses/android-sdk-license
          echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" >> $ANDROID_SDK_ROOT/licenses/android-sdk-license
          echo "âœ… SDK license file written!"
      
      # =========================================
      # æ­¥éª¤5: å®‰è£…Android SDKç»„ä»¶
      # ä½œç”¨ï¼šå®‰è£…æ‰“åŒ…æ‰€éœ€çš„æ‰€æœ‰SDKç»„ä»¶ï¼š
      #       - build-tools;34.0.0ï¼ˆç¼–è¯‘å·¥å…·ï¼Œè§£å†³build-toolsç¼ºå¤±ï¼‰
      #       - platform-toolsï¼ˆADBç­‰å·¥å…·ï¼‰
      #       - platforms;android-34ï¼ˆç›®æ ‡å¹³å°ï¼‰
      #       - ndk;25.2.9519653ï¼ˆåŽŸç”Ÿå¼€å‘å·¥å…·åŒ…ï¼ŒKivyå¿…éœ€ï¼‰
      # =========================================
      - name: Install Android SDK Components
        run: |
          echo "ðŸ“¦ Installing Android SDK components..."
          sdkmanager --install "build-tools;34.0.0"
          sdkmanager --install "platform-tools"
          sdkmanager --install "platforms;android-34"
          sdkmanager --install "ndk;25.2.9519653"
          echo "âœ… All SDK components installed!"
      
      # =========================================
      # æ­¥éª¤6: éªŒè¯AndroidçŽ¯å¢ƒ
      # ä½œç”¨ï¼šæ‰“å°çŽ¯å¢ƒå˜é‡å’Œå·²å®‰è£…ç»„ä»¶ï¼Œä¾¿äºŽè°ƒè¯•
      # =========================================
      - name: Verify Android Environment
        run: |
          echo "ðŸ” Verifying Android environment..."
          echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
          echo "ANDROID_HOME: $ANDROID_HOME"
          echo "ANDROID_NDK_HOME: $ANDROID_NDK_HOME"
          echo ""
          echo "ðŸ“‹ Installed SDK components:"
          sdkmanager --list_installed
          echo "âœ… Android environment verified!"
      
      # =========================================
      # æ­¥éª¤7: è®¾ç½®PythonçŽ¯å¢ƒ
      # ä½œç”¨ï¼šå®‰è£…Python 3.10ï¼ŒKivy/Buildozerè¿è¡ŒçŽ¯å¢ƒ
      # =========================================
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      # =========================================
      # æ­¥éª¤8: å®‰è£…ç³»ç»Ÿä¾èµ–
      # ä½œç”¨ï¼šå®‰è£…Kivyå’ŒBuildozerç¼–è¯‘æ‰€éœ€çš„ç³»ç»Ÿåº“ï¼š
      #       - SDL2ç³»åˆ—ï¼ˆå›¾å½¢/éŸ³é¢‘ï¼‰
      #       - FFmpegï¼ˆåª’ä½“å¤„ç†ï¼‰
      #       - GStreamerï¼ˆå¤šåª’ä½“æ¡†æž¶ï¼‰
      #       - ç¼–è¯‘å·¥å…·é“¾
      # =========================================
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-pip \
            build-essential \
            git \
            ffmpeg \
            libsdl2-dev \
            libsdl2-image-dev \
            libsdl2-mixer-dev \
            libsdl2-ttf-dev \
            libportmidi-dev \
            libswscale-dev \
            libavformat-dev \
            libavcodec-dev \
            zlib1g-dev \
            libgstreamer1.0-dev \
            gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good \
            libgstreamer-plugins-base1.0-dev \
            libffi-dev \
            libssl-dev \
            autoconf \
            automake \
            libtool \
            pkg-config \
            zip \
            unzip \
            wget \
            lld \
            ccache
      
      # =========================================
      # æ­¥éª¤9: å®‰è£…Pythonä¾èµ–
      # ä½œç”¨ï¼šå®‰è£…Buildozerå’ŒKivyæ‰“åŒ…å·¥å…·é“¾ï¼š
      #       - buildozerï¼ˆAndroidæ‰“åŒ…å·¥å…·ï¼‰
      #       - cython 0.29.33ï¼ˆå…¼å®¹ç‰ˆæœ¬ï¼Œé¿å…ç¼–è¯‘é”™è¯¯ï¼‰
      #       - kivy 2.2.1ï¼ˆUIæ¡†æž¶ï¼‰
      # =========================================
      - name: Install Python Dependencies
        run: |
          pip install --upgrade pip wheel setuptools
          pip install \
            buildozer==1.5.0 \
            cython==0.29.33 \
            virtualenv \
            kivy==2.2.1
      
      # =========================================
      # æ­¥éª¤10: ä¸‹è½½Voskè¯­éŸ³æ¨¡åž‹
      # ä½œç”¨ï¼šä¸‹è½½æè¯å™¨é¡¹ç›®æ‰€éœ€çš„Voskè‹±è¯­è¯­éŸ³è¯†åˆ«æ¨¡åž‹
      # =========================================
      - name: Download Vosk Model
        run: |
          echo "ðŸ“¥ Downloading Vosk English Model..."
          wget -q https://alphacephei.com/vosk/models/vosk-model-small-en-us-0.15.zip
          unzip -q vosk-model-small-en-us-0.15.zip
          echo "âœ… Vosk model downloaded successfully!"
      
      # =========================================
      # æ­¥éª¤11: é…ç½®Buildozerç¼“å­˜
      # ä½œç”¨ï¼šç¼“å­˜Buildozerä¸‹è½½çš„ä¾èµ–ï¼ŒåŠ é€ŸåŽç»­æž„å»º
      # =========================================
      - name: Cache Buildozer
        uses: actions/cache@v4
        with:
          path: |
            ~/.buildozer
            .buildozer
          key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}
          restore-keys: |
            ${{ runner.os }}-buildozer-
      
      # =========================================
      # æ­¥éª¤12: é…ç½®BuildozerçŽ¯å¢ƒå˜é‡
      # ä½œç”¨ï¼šå°†Android SDK/NDKè·¯å¾„å†™å…¥çŽ¯å¢ƒï¼Œ
      #       ç¡®ä¿Buildozerèƒ½æ­£ç¡®è¯†åˆ«å®‰å“çŽ¯å¢ƒ
      # =========================================
      - name: Configure Buildozer Environment
        run: |
          echo "ðŸ”§ Configuring Buildozer environment..."
          # åˆ›å»º.buildozerç›®å½•
          mkdir -p ~/.buildozer/android/platform
          
          # å†™å…¥çŽ¯å¢ƒå˜é‡åˆ°bashrcç¡®ä¿å­è¿›ç¨‹å¯ç”¨
          echo "export ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> ~/.bashrc
          echo "export ANDROID_HOME=$ANDROID_HOME" >> ~/.bashrc
          echo "export ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> ~/.bashrc
          echo "export PATH=\$PATH:$ANDROID_SDK_ROOT/tools:$ANDROID_SDK_ROOT/platform-tools" >> ~/.bashrc
          
          echo "âœ… Buildozer environment configured!"
      
      # =========================================
      # æ­¥éª¤13: åˆå§‹åŒ–Buildozerå¹¶æŽ¥å—è®¸å¯
      # ä½œç”¨ï¼šé€šè¿‡Buildozerå†æ¬¡ç¡®è®¤SDKè®¸å¯å·²æŽ¥å—
      # =========================================
      - name: Initialize Buildozer
        run: |
          echo "ðŸ”§ Initializing Buildozer..."
          yes | buildozer android licenses 2>/dev/null || true
          echo "âœ… Buildozer initialized!"
      
      # =========================================
      # æ­¥éª¤14: æž„å»ºAPKï¼ˆæ ¸å¿ƒæž„å»ºæ­¥éª¤ï¼‰
      # ä½œç”¨ï¼šä½¿ç”¨Buildozerç¼–è¯‘Android APK
      #       - ä¼ å…¥æ‰€æœ‰å¿…è¦çš„çŽ¯å¢ƒå˜é‡
      #       - ä½¿ç”¨-vå‚æ•°æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—
      #       - é¦–æ¬¡æž„å»ºçº¦éœ€15-30åˆ†é’Ÿ
      # =========================================
      - name: Build APK
        run: |
          echo "ðŸ”¨ Building Android APK..."
          echo "This may take 15-30 minutes on first build..."
          buildozer -v android debug
        env:
          BUILDOZER_WARN_ON_ROOT: 0
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
          ANDROID_HOME: ${{ env.ANDROID_HOME }}
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
          # æŒ‡å®šNDKç‰ˆæœ¬ï¼Œé¿å…è‡ªåŠ¨ä¸‹è½½
          ANDROIDNDK: ${{ env.ANDROID_NDK_HOME }}
          ANDROIDSDK: ${{ env.ANDROID_SDK_ROOT }}
      
      # =========================================
      # æ­¥éª¤15: ä¸Šä¼ APKäº§ç‰©
      # ä½œç”¨ï¼šå°†ç¼–è¯‘å¥½çš„APKä¸Šä¼ ä¸ºGitHub Artifact
      #       ä¿ç•™30å¤©ï¼Œå¯ä»ŽActionsé¡µé¢ä¸‹è½½
      # =========================================
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: teleprompter-apk
          path: bin/*.apk
          retention-days: 30
          if-no-files-found: error
      
      # =========================================
      # æ­¥éª¤16: æž„å»ºæ‘˜è¦
      # ä½œç”¨ï¼šåœ¨GitHub Actions Summaryé¡µé¢æ˜¾ç¤ºæž„å»ºä¿¡æ¯
      # =========================================
      - name: Build Summary
        run: |
          echo "## ðŸŽ‰ Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± APK Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lh bin/*.apk 2>/dev/null || echo "APK file generated"
          ls -lh bin/*.apk >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Check artifacts for APK" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Download" >> $GITHUB_STEP_SUMMARY
          echo "Download the APK from the **Artifacts** section above." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Build Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Type:** Debug" >> $GITHUB_STEP_SUMMARY
          echo "- **Architecture:** ARM64" >> $GITHUB_STEP_SUMMARY
          echo "- **Min Android:** 7.0+ (API 24)" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Android:** 14 (API 34)" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Tools:** 34.0.0" >> $GITHUB_STEP_SUMMARY
          echo "- **NDK Version:** 25.2.9519653" >> $GITHUB_STEP_SUMMARY
