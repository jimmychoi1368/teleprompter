# =============================================================================
# GitHub Actions - Android APK Build (极简版 v5.0)
# =============================================================================
# 步骤数：10步（极简流程）
# 验证方式：buildozer android printconf（Buildozer自带命令）
# 日志捕获：buildozer_final.log（100%可靠）
# =============================================================================
name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      ANDROID_HOME: /usr/local/lib/android/sdk
      ANDROID_NDK_VERSION: 25.2.9519653

    steps:
      # ===========================================
      # 步骤1：拉取代码
      # ===========================================
      - name: Checkout code
        uses: actions/checkout@v4

      # ===========================================
      # 步骤2：设置Python + Java
      # ===========================================
      - name: Setup Python and Java
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # ===========================================
      # 步骤3：设置Android SDK + 安装组件
      # ===========================================
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true

      - name: Install SDK Components
        run: |
          yes | sdkmanager --licenses || true
          sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.2" "ndk;$ANDROID_NDK_VERSION"
          mkdir -p $ANDROID_SDK_ROOT/licenses
          echo -e "\n8933bad161af4178b1185d1a37fbf41ea5269c55\nd56f5187479451eabf01fb78af6dfcb131a6481e\n24333f8a63b6825ea9c5514f83c2829b004d1fee" > $ANDROID_SDK_ROOT/licenses/android-sdk-license

      # ===========================================
      # 步骤4：安装系统依赖
      # ===========================================
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git zip unzip python3-pip python3-dev \
            libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
            libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev zlib1g-dev \
            libgstreamer1.0-dev gstreamer1.0-plugins-base libgstreamer-plugins-base1.0-dev \
            libffi-dev libssl-dev autoconf automake libtool cmake ccache lld wget

      # ===========================================
      # 步骤5：安装Python依赖
      # ===========================================
      - name: Install Python Dependencies
        run: |
          pip install --upgrade pip wheel setuptools
          pip install buildozer==1.5.0 cython==0.29.33 kivy==2.2.1

      # ===========================================
      # 步骤6：下载Vosk模型
      # ===========================================
      - name: Download Vosk Model
        run: |
          wget -q https://alphacephei.com/vosk/models/vosk-model-small-en-us-0.15.zip
          unzip -q vosk-model-small-en-us-0.15.zip

      # ===========================================
      # 步骤7：配置Buildozer SDK目录（符号链接）
      # ===========================================
      - name: Setup Buildozer SDK
        run: |
          rm -rf ~/.buildozer .buildozer
          mkdir -p ~/.buildozer/android/platform
          ln -sf $ANDROID_SDK_ROOT ~/.buildozer/android/platform/android-sdk
          ln -sf $ANDROID_SDK_ROOT/build-tools/33.0.2/aapt /usr/local/bin/aapt 2>/dev/null || sudo ln -sf $ANDROID_SDK_ROOT/build-tools/33.0.2/aapt /usr/local/bin/aapt

      # ===========================================
      # 步骤8：打印Buildozer实际配置（用自带命令）
      # ===========================================
      - name: Print Buildozer Config
        run: |
          echo "=== Buildozer实际读取的配置 ==="
          buildozer android printconf || echo "printconf not available, showing spec:"
          echo ""
          echo "=== buildozer.spec关键配置 ==="
          grep -E "^(android\.|requirements)" buildozer.spec | head -20

      # ===========================================
      # 步骤9：构建APK（详细日志）
      # ===========================================
      - name: Build APK
        id: build
        run: |
          export PATH="$ANDROID_SDK_ROOT/build-tools/33.0.2:$ANDROID_SDK_ROOT/platform-tools:$PATH"
          set +e
          buildozer android debug --verbose 2>&1 | tee buildozer_final.log
          BUILD_CODE=$?
          set -e
          
          if ls bin/*.apk 1>/dev/null 2>&1; then
            echo "apk_exists=true" >> $GITHUB_OUTPUT
          else
            echo "apk_exists=false" >> $GITHUB_OUTPUT
          fi
          
          echo ""
          echo "=== 构建日志最后100行 ==="
          tail -100 buildozer_final.log
        env:
          BUILDOZER_WARN_ON_ROOT: 0

      # ===========================================
      # 步骤10：上传日志和APK
      # ===========================================
      - name: Upload Build Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: buildozer_final.log
          if-no-files-found: warn

      - name: Upload APK
        if: steps.build.outputs.apk_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: teleprompter-apk
          path: bin/*.apk

      - name: Build Result
        if: always()
        run: |
          if [ "${{ steps.build.outputs.apk_exists }}" == "true" ]; then
            echo "✅ APK生成成功！"
            ls -lh bin/*.apk
          else
            echo "❌ APK生成失败，请下载build-log查看详细错误"
            echo "=== 错误摘要 ==="
            grep -i "error\|failed\|exception" buildozer_final.log | tail -30 || true
            exit 1
          fi
