# =============================================================================
# GitHub Actions workflow for building Android APK with Buildozer
# =============================================================================
# ã€é‡è¦å£°æ˜Žã€‘æœ¬é…ç½®æ–‡ä»¶ä»…å±žäºŽã€Œteleprompterã€ä»“åº“
# =============================================================================
name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      ANDROID_HOME: /usr/local/lib/android/sdk
      ANDROID_NDK_VERSION: 25.2.9519653
      ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/25.2.9519653
      ANDROID_BUILD_TOOLS_VERSION: 33.0.2
      ANDROID_PLATFORM_VERSION: 33

    steps:
      # =========================================
      # æ­¥éª¤1ï¼šæ‹‰å–ä»£ç 
      # =========================================
      - name: Checkout code
        uses: actions/checkout@v4

      # =========================================
      # æ­¥éª¤2ï¼šè®¾ç½®JDK 17ï¼ˆAndroidæ‰“åŒ…å¿…éœ€ï¼‰
      # ã€ä¿®å¤é—®é¢˜2ã€‘æ·»åŠ ç¼ºå¤±çš„JavaçŽ¯å¢ƒ
      # =========================================
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # =========================================
      # æ­¥éª¤3ï¼šè®¾ç½®Android SDKï¼ˆä»…æŽ¥å—è®¸å¯ï¼‰
      # ã€ä¿®å¤é—®é¢˜1ã€‘ç§»é™¤æ— æ•ˆå‚æ•°ï¼Œä»…ä¿ç•™accept-android-sdk-licenses
      # =========================================
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true

      # =========================================
      # æ­¥éª¤4ï¼šæ‰‹åŠ¨å®‰è£…SDKç»„ä»¶
      # ã€ä¿®å¤é—®é¢˜4ã€‘ç”¨sdkmanagerå‘½ä»¤æ‰‹åŠ¨å®‰è£…æ‰€æœ‰ç»„ä»¶
      # =========================================
      - name: Install Android SDK Components
        run: |
          echo "ðŸ“¦ Installing Android SDK components..."
          sdkmanager --sdk_root=$ANDROID_SDK_ROOT "platform-tools"
          sdkmanager --sdk_root=$ANDROID_SDK_ROOT "platforms;android-$ANDROID_PLATFORM_VERSION"
          sdkmanager --sdk_root=$ANDROID_SDK_ROOT "build-tools;$ANDROID_BUILD_TOOLS_VERSION"
          sdkmanager --sdk_root=$ANDROID_SDK_ROOT "ndk;$ANDROID_NDK_VERSION"
          echo "âœ… SDK components installed!"

      # =========================================
      # æ­¥éª¤5ï¼šæ‰‹åŠ¨å†™å…¥SDKè®¸å¯æ–‡ä»¶
      # ã€ä¿®å¤é—®é¢˜5ã€‘åŒé‡ä¿éšœï¼Œç¡®ä¿è®¸å¯æ–‡ä»¶å­˜åœ¨
      # =========================================
      - name: Write SDK License Files
        run: |
          echo "ðŸ“œ Writing SDK license files..."
          mkdir -p $ANDROID_SDK_ROOT/licenses
          echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > $ANDROID_SDK_ROOT/licenses/android-sdk-license
          echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> $ANDROID_SDK_ROOT/licenses/android-sdk-license
          echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" >> $ANDROID_SDK_ROOT/licenses/android-sdk-license
          echo "84831b9409646a918e30573bab4c9c91346d8abd" > $ANDROID_SDK_ROOT/licenses/android-sdk-preview-license
          echo "âœ… License files written!"

      # =========================================
      # æ­¥éª¤6ï¼šå°†Build ToolsåŠ å…¥PATH
      # =========================================
      - name: Add Build Tools to PATH
        run: |
          echo "$ANDROID_SDK_ROOT/build-tools/$ANDROID_BUILD_TOOLS_VERSION" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH

      # =========================================
      # æ­¥éª¤7ï¼šéªŒè¯SDKå®‰è£…
      # =========================================
      - name: Verify Android SDK
        run: |
          echo "ðŸ” Verifying SDK installation..."
          echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
          ls -la $ANDROID_SDK_ROOT/build-tools/$ANDROID_BUILD_TOOLS_VERSION/aapt || echo "aapt not found!"
          ls -la $ANDROID_SDK_ROOT/ndk/$ANDROID_NDK_VERSION/ || echo "NDK not found!"
          echo "âœ… Verification complete!"

      # =========================================
      # æ­¥éª¤8ï¼šè®¾ç½®PythonçŽ¯å¢ƒ
      # =========================================
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # =========================================
      # æ­¥éª¤9ï¼šå®‰è£…ç³»ç»Ÿä¾èµ–
      # ã€ä¿®å¤é—®é¢˜3ã€‘æ·»åŠ Buildozerç¼–è¯‘æ‰€éœ€çš„æ‰€æœ‰ç³»ç»Ÿåº“
      # =========================================
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            git \
            zip \
            unzip \
            python3-pip \
            ffmpeg \
            libsdl2-dev \
            libsdl2-image-dev \
            libsdl2-mixer-dev \
            libsdl2-ttf-dev \
            libportmidi-dev \
            libswscale-dev \
            libavformat-dev \
            libavcodec-dev \
            zlib1g-dev \
            libgstreamer1.0-dev \
            gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good \
            libgstreamer-plugins-base1.0-dev \
            libffi-dev \
            libssl-dev \
            autoconf \
            automake \
            libtool \
            pkg-config \
            wget \
            lld \
            ccache

      # =========================================
      # æ­¥éª¤10ï¼šå®‰è£…Pythonä¾èµ–
      # =========================================
      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install buildozer==1.5.0 cython==0.29.33 kivy==2.2.1

      # =========================================
      # æ­¥éª¤11ï¼šä¸‹è½½Voskæ¨¡åž‹
      # ã€ä¿®å¤é—®é¢˜7ã€‘æ·»åŠ è¯­éŸ³æ¨¡åž‹ä¸‹è½½
      # =========================================
      - name: Download Vosk Model
        run: |
          echo "ðŸ“¥ Downloading Vosk model..."
          wget -q https://alphacephei.com/vosk/models/vosk-model-small-en-us-0.15.zip
          unzip -q vosk-model-small-en-us-0.15.zip
          echo "âœ… Vosk model ready!"

      # =========================================
      # æ­¥éª¤12ï¼šé…ç½®Buildozerç¼“å­˜
      # =========================================
      - name: Cache Buildozer
        uses: actions/cache@v4
        with:
          path: |
            ~/.buildozer
            .buildozer
          key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}
          restore-keys: |
            ${{ runner.os }}-buildozer-

      # =========================================
      # æ­¥éª¤13ï¼šæ¸…ç†Buildozerç§æœ‰SDK
      # ã€ä¿®å¤é—®é¢˜6ã€‘ç¡®ä¿ä½¿ç”¨ç³»ç»ŸSDKè€Œéžç¼“å­˜çš„ç§æœ‰SDK
      # =========================================
      - name: Clean Buildozer Private SDK
        run: |
          echo "ðŸ§¹ Cleaning cached private SDK..."
          rm -rf ~/.buildozer/android/platform/android-sdk 2>/dev/null || true
          rm -rf ~/.buildozer/android/platform/android-ndk* 2>/dev/null || true
          echo "âœ… Private SDK cleaned!"

      # =========================================
      # æ­¥éª¤14ï¼šæž„å»ºAPK
      # =========================================
      - name: Build APK with Buildozer
        run: |
          echo "ðŸ”¨ Building Android APK..."
          echo "This may take 15-30 minutes on first build..."
          buildozer -v android debug
        env:
          BUILDOZER_WARN_ON_ROOT: 0
          ANDROIDSDK: ${{ env.ANDROID_SDK_ROOT }}
          ANDROIDNDK: ${{ env.ANDROID_NDK_HOME }}

      # =========================================
      # æ­¥éª¤15ï¼šä¸Šä¼ APKäº§ç‰©
      # ã€ä¿®å¤é—®é¢˜8ã€‘æ·»åŠ if-no-files-foundæ˜Žç¡®æŠ¥é”™
      # =========================================
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: teleprompter-apk
          path: bin/*.apk
          retention-days: 30
          if-no-files-found: error

      # =========================================
      # æ­¥éª¤16ï¼šæž„å»ºæ‘˜è¦
      # =========================================
      - name: Build Summary
        if: always()
        run: |
          echo "## Build Result" >> $GITHUB_STEP_SUMMARY
          if ls bin/*.apk 1>/dev/null 2>&1; then
            echo "### âœ… APK Generated Successfully!" >> $GITHUB_STEP_SUMMARY
            ls -lh bin/*.apk >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ APK Generation Failed" >> $GITHUB_STEP_SUMMARY
          fi
