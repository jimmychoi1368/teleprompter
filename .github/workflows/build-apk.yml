name: Build Android APK
on: [push]
jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      # 步骤0：第一步就创建日志文件，写入环境基础信息（测试环境的核心）
      - name: 0. 强制创建日志+探测环境
        run: |
          # 先创建日志文件，确保绝对存在
          touch buildozer-final.log
          # 写入构建开始时间
          echo "===== 构建开始：$(date) =====" >> buildozer-final.log
          # 探测系统环境（测试GitHub环境的核心内容）
          echo "===== 1. 系统版本信息 =====" >> buildozer-final.log
          lsb_release -a >> buildozer-final.log 2>&1
          echo "===== 2. Python版本 =====" >> buildozer-final.log
          python --version >> buildozer-final.log 2>&1
          python3 --version >> buildozer-final.log 2>&1
          echo "===== 3. JDK版本 =====" >> buildozer-final.log
          java -version >> buildozer-final.log 2>&1
          echo "===== 4. 预装Android SDK信息 =====" >> buildozer-final.log
          ls -la /usr/local/lib/android/sdk/ >> buildozer-final.log 2>&1

      # 步骤1：拉取代码，日志追加
      - name: 1. 拉取代码
        run: |
          echo "===== 拉取代码开始 =====" >> buildozer-final.log
          git pull origin main >> buildozer-final.log 2>&1 || echo "拉取代码失败（首次拉取无影响）" >> buildozer-final.log
          echo "===== 拉取代码结束 =====" >> buildozer-final.log

      # 步骤2：固化Python+JDK版本，日志追加
      - name: 2. 安装Python 3.10 + JDK 11
        uses: actions/setup-python@v5
        with:
          python-version: "3.10.14"
      - uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "11.0.22"
      - name: 记录Python/JDK安装结果
        run: |
          echo "===== Python/JDK安装结果 =====" >> buildozer-final.log
          python --version >> buildozer-final.log 2>&1
          java -version >> buildozer-final.log 2>&1

      # 步骤3：安装系统依赖，日志追加
      - name: 3. 安装系统依赖（解决SSL/JAXB）
        run: |
          echo "===== 安装系统依赖开始 =====" >> buildozer-final.log
          sudo apt update >> buildozer-final.log 2>&1
          sudo apt install -y python3-dev libssl-dev libjaxb-java >> buildozer-final.log 2>&1
          echo "===== 安装系统依赖结束 =====" >> buildozer-final.log

      # 步骤4：安装Python依赖（固化版本），日志追加
      - name: 4. 安装Python依赖
        run: |
          echo "===== 安装Python依赖开始 =====" >> buildozer-final.log
          pip install --upgrade pip >> buildozer-final.log 2>&1
          pip install buildozer==1.5.0 cython==0.29.33 kivy==2.2.1 >> buildozer-final.log 2>&1
          echo "===== 安装Python依赖结束 =====" >> buildozer-final.log

      # 步骤5：安装SDK组件（固化版本），增加重试逻辑
      - name: 5. 安装SDK组件（33.0.2，增加重试）
        run: |
          echo "===== 安装SDK组件开始（重试3次） =====" >> buildozer-final.log
          # 网络断连时重试3次，每次失败都写日志
          for i in {1..3}; do
            echo "第$i次尝试安装SDK组件" >> buildozer-final.log
            yes | sdkmanager --licenses >> buildozer-final.log 2>&1
            sdkmanager "platforms;android-33" "build-tools;33.0.2" "ndk;25.2.9519653" >> buildozer-final.log 2>&1
            if [ $? -eq 0 ]; then
              echo "SDK组件安装成功" >> buildozer-final.log
              break
            else
              echo "第$i次安装失败，等待5秒重试" >> buildozer-final.log
              sleep 5
            fi
          done
          # 不管成功失败，都写结果到日志
          if [ $i -eq 3 ]; then
            echo "SDK组件3次安装均失败" >> buildozer-final.log
          fi
          echo "===== 安装SDK组件结束 =====" >> buildozer-final.log

      # 步骤6：清理缓存+创建链接，日志追加
      - name: 6. 清理缓存+创建SDK链接
        run: |
          echo "===== 清理缓存开始 =====" >> buildozer-final.log
          rm -rf ~/.buildozer >> buildozer-final.log 2>&1
          ln -s /usr/local/lib/android/sdk ~/.buildozer/android/platform/android-sdk >> buildozer-final.log 2>&1
          echo "===== 清理缓存结束 =====" >> buildozer-final.log

      # 步骤7：构建APK，日志追加（失败也写）
      - name: 7. 构建APK
        run: |
          echo "===== 构建APK开始 =====" >> buildozer-final.log
          buildozer android debug --verbose >> buildozer-final.log 2>&1
          # 记录错误码，哪怕失败也写
          echo "构建错误码：$?" >> buildozer-final.log
          echo "===== 构建APK结束 =====" >> buildozer-final.log

      # 步骤8：强制上传日志（绝对不能漏，无论任何情况）
      - name: 8. 强制上传日志（必传，无论任何情况）
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: buildozer-final.log
