# =============================================================================
# GitHub Actions - Android APK Build (v7.0 æ¨å€’é‡æ¥ç‰ˆ)
# =============================================================================
# é€»è¾‘ï¼šç¯å¢ƒæ¢æµ‹ â†’ ç‰ˆæœ¬å›ºåŒ– â†’ é¢„éªŒè¯ â†’ æ„å»º â†’ ä¸Šä¼ æ—¥å¿—
# è®¾è®¡åŸåˆ™ï¼šå…ˆæ‘¸æ¸…ç¯å¢ƒå†å†™ä»£ç ï¼Œæ‰€æœ‰ç‰ˆæœ¬ç¡¬ç¼–ç ï¼Œé¢„éªŒè¯é€šè¿‡æ‰æ„å»º
# =============================================================================
name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  # ===== ç‰ˆæœ¬ç¡¬ç¼–ç ï¼ˆæœç»è‡ªåŠ¨æ›´æ–°ï¼‰=====
  PYTHON_VERSION: "3.10"
  JDK_VERSION: "11"
  ANDROID_API: "33"
  BUILD_TOOLS: "33.0.2"
  NDK_VERSION: "25.2.9519653"
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk

jobs:
  build:
    runs-on: ubuntu-22.04
    # å›ºåŒ–Ubuntuç‰ˆæœ¬ä¸º22.04ï¼Œé¿å…24.04çš„å…¼å®¹æ€§é—®é¢˜

    steps:
      # ===========================================
      # æ­¥éª¤1ï¼šç¯å¢ƒæ¢æµ‹ï¼ˆäº†è§£GitHub Actionså½“å‰ç¯å¢ƒï¼‰
      # ===========================================
      - name: "1ï¸âƒ£ ç¯å¢ƒæ¢æµ‹"
        run: |
          echo "===== ç³»ç»Ÿä¿¡æ¯ ====="
          lsb_release -a || cat /etc/os-release
          echo ""
          echo "===== é¢„è£…Javaç‰ˆæœ¬ ====="
          java -version 2>&1 || echo "Javaæœªé¢„è£…"
          echo ""
          echo "===== é¢„è£…Pythonç‰ˆæœ¬ ====="
          python3 --version || echo "Python3æœªé¢„è£…"
          echo ""
          echo "===== é¢„è£…SDKè·¯å¾„ ====="
          echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
          ls -la $ANDROID_SDK_ROOT 2>/dev/null || echo "SDKç›®å½•ä¸å­˜åœ¨"
          echo ""
          echo "===== é¢„è£…build-tools ====="
          ls $ANDROID_SDK_ROOT/build-tools/ 2>/dev/null || echo "æ— é¢„è£…build-tools"
          echo ""
          echo "===== ç¯å¢ƒæ¢æµ‹å®Œæˆ ====="

      # ===========================================
      # æ­¥éª¤2ï¼šç‰ˆæœ¬å›ºåŒ–ï¼ˆå¼ºåˆ¶ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬ï¼‰
      # ===========================================
      - name: "2ï¸âƒ£ æ‹‰å–ä»£ç "
        uses: actions/checkout@v4

      - name: "2ï¸âƒ£ å›ºåŒ–Pythonç‰ˆæœ¬"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: "2ï¸âƒ£ å›ºåŒ–JDKç‰ˆæœ¬ï¼ˆJDK11è§£å†³JAXBé—®é¢˜ï¼‰"
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JDK_VERSION }}

      - name: "2ï¸âƒ£ å›ºåŒ–Android SDK"
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true

      - name: "2ï¸âƒ£ å›ºåŒ–SDKç»„ä»¶ç‰ˆæœ¬"
        run: |
          echo "===== åˆ é™¤æ—§ç‰ˆtoolsï¼ˆè§£å†³JAXBå…¼å®¹é—®é¢˜ï¼‰====="
          rm -rf $ANDROID_SDK_ROOT/tools
          
          echo "===== æ¥å—æ‰€æœ‰è®¸å¯ ====="
          yes | sdkmanager --licenses || true
          
          echo "===== å®‰è£…å›ºå®šç‰ˆæœ¬ç»„ä»¶ ====="
          sdkmanager "platform-tools"
          sdkmanager "platforms;android-${{ env.ANDROID_API }}"
          sdkmanager "build-tools;${{ env.BUILD_TOOLS }}"
          sdkmanager "ndk;${{ env.NDK_VERSION }}"
          
          echo "===== å†™å…¥è®¸å¯æ–‡ä»¶ ====="
          mkdir -p $ANDROID_SDK_ROOT/licenses
          echo -e "\n8933bad161af4178b1185d1a37fbf41ea5269c55\nd56f5187479451eabf01fb78af6dfcb131a6481e" > $ANDROID_SDK_ROOT/licenses/android-sdk-license

      - name: "2ï¸âƒ£ å®‰è£…ç³»ç»Ÿä¾èµ–"
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git zip unzip python3-dev libssl-dev \
            libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev libportmidi-dev \
            libswscale-dev libavformat-dev libavcodec-dev zlib1g-dev libffi-dev \
            libgstreamer1.0-dev gstreamer1.0-plugins-base libgstreamer-plugins-base1.0-dev \
            autoconf automake libtool cmake ccache lld wget

      - name: "2ï¸âƒ£ å®‰è£…Pythonä¾èµ–ï¼ˆå›ºå®šç‰ˆæœ¬ï¼‰"
        run: |
          pip install --upgrade pip wheel setuptools
          pip install buildozer==1.5.0 cython==0.29.33 kivy==2.2.1

      - name: "2ï¸âƒ£ ä¸‹è½½Voskæ¨¡å‹"
        run: |
          wget -q --timeout=120 https://alphacephei.com/vosk/models/vosk-model-small-en-us-0.15.zip
          unzip -q vosk-model-small-en-us-0.15.zip

      # ===========================================
      # æ­¥éª¤3ï¼šé¢„éªŒè¯ï¼ˆç¡®ä¿ç¯å¢ƒæ­£ç¡®å†æ„å»ºï¼‰
      # ===========================================
      - name: "3ï¸âƒ£ é¢„éªŒè¯ç¯å¢ƒ"
        run: |
          echo "===== é¢„éªŒè¯å¼€å§‹ ====="
          FAIL=0
          
          echo -n "æ£€æŸ¥Pythonç‰ˆæœ¬... "
          python --version | grep -q "3.10" && echo "âœ… Python 3.10" || { echo "âŒ Pythonç‰ˆæœ¬ä¸å¯¹"; FAIL=1; }
          
          echo -n "æ£€æŸ¥JDKç‰ˆæœ¬... "
          java -version 2>&1 | grep -q "11" && echo "âœ… JDK 11" || { echo "âŒ JDKç‰ˆæœ¬ä¸å¯¹"; FAIL=1; }
          
          echo -n "æ£€æŸ¥SSLæ¨¡å—... "
          python -c "import ssl; print('âœ… SSLæ¨¡å—å¯ç”¨')" || { echo "âŒ SSLæ¨¡å—ä¸å¯ç”¨"; FAIL=1; }
          
          echo -n "æ£€æŸ¥build-tools... "
          ls $ANDROID_SDK_ROOT/build-tools/${{ env.BUILD_TOOLS }}/aapt >/dev/null 2>&1 && echo "âœ… build-tools ${{ env.BUILD_TOOLS }}" || { echo "âŒ build-toolsç¼ºå¤±"; FAIL=1; }
          
          echo -n "æ£€æŸ¥NDK... "
          ls $ANDROID_SDK_ROOT/ndk/${{ env.NDK_VERSION }} >/dev/null 2>&1 && echo "âœ… NDK ${{ env.NDK_VERSION }}" || { echo "âŒ NDKç¼ºå¤±"; FAIL=1; }
          
          echo -n "æ£€æŸ¥Voskæ¨¡å‹... "
          ls vosk-model-small-en-us-0.15 >/dev/null 2>&1 && echo "âœ… Voskæ¨¡å‹å­˜åœ¨" || { echo "âŒ Voskæ¨¡å‹ç¼ºå¤±"; FAIL=1; }
          
          echo ""
          if [ $FAIL -eq 0 ]; then
            echo "===== âœ… é¢„éªŒè¯å…¨éƒ¨é€šè¿‡ ====="
          else
            echo "===== âŒ é¢„éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šè¿°é”™è¯¯ ====="
            exit 1
          fi

      # ===========================================
      # æ­¥éª¤4ï¼šæ„å»ºAPK
      # ===========================================
      - name: "4ï¸âƒ£ é…ç½®Buildozer SDK"
        run: |
          rm -rf ~/.buildozer .buildozer
          mkdir -p ~/.buildozer/android/platform
          ln -sf $ANDROID_SDK_ROOT ~/.buildozer/android/platform/android-sdk

      - name: "4ï¸âƒ£ æ„å»ºAPK"
        id: build
        run: |
          export PATH="$ANDROID_SDK_ROOT/build-tools/${{ env.BUILD_TOOLS }}:$ANDROID_SDK_ROOT/platform-tools:$PATH"
          buildozer android debug --verbose 2>&1 | tee buildozer-final.log || true
          
          if ls bin/*.apk 1>/dev/null 2>&1; then
            echo "apk_exists=true" >> $GITHUB_OUTPUT
            echo "===== âœ… APKç”ŸæˆæˆåŠŸ ====="
            ls -lh bin/*.apk
          else
            echo "apk_exists=false" >> $GITHUB_OUTPUT
            echo "===== âŒ APKæœªç”Ÿæˆ ====="
          fi
        env:
          BUILDOZER_WARN_ON_ROOT: 0

      # ===========================================
      # æ­¥éª¤5ï¼šä¸Šä¼ æ—¥å¿—å’ŒAPK
      # ===========================================
      - name: "5ï¸âƒ£ ä¸Šä¼ æ„å»ºæ—¥å¿—"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: buildozer-final.log
          if-no-files-found: warn

      - name: "5ï¸âƒ£ ä¸Šä¼ APK"
        if: steps.build.outputs.apk_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: teleprompter-apk
          path: bin/*.apk

      - name: "5ï¸âƒ£ æ„å»ºç»“æœ"
        if: always()
        run: |
          if [ "${{ steps.build.outputs.apk_exists }}" == "true" ]; then
            echo "ğŸ‰ æ„å»ºæˆåŠŸï¼APKå·²ä¸Šä¼ åˆ°Artifacts"
          else
            echo "âŒ æ„å»ºå¤±è´¥ï¼Œè¯·ä¸‹è½½build-logæŸ¥çœ‹è¯¦ç»†é”™è¯¯"
            echo ""
            echo "===== é”™è¯¯æ‘˜è¦ï¼ˆæœ€å30è¡Œï¼‰====="
            tail -30 buildozer-final.log 2>/dev/null || echo "æ—¥å¿—ä¸å­˜åœ¨"
            exit 1
          fi
