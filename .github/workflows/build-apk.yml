# =============================================================================
# GitHub Actions workflow for building Android APK with Buildozer
# =============================================================================
# ã€é‡è¦å£°æ˜Žã€‘æœ¬é…ç½®æ–‡ä»¶ä»…å±žäºŽã€Œteleprompterã€ä»“åº“
# 
# ã€ä¿®å¤è®°å½•ã€‘é’ˆå¯¹ä»¥ä¸‹æŠ¥é”™çš„å½»åº•ä¿®å¤ï¼š
# - aapt not found
# - the license is not accepted  
# - Android SDK Build-tools 34.1 æœªè¢«å®‰è£…
# =============================================================================
name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      ANDROID_HOME: /usr/local/lib/android/sdk
      ANDROID_NDK_VERSION: 25.2.9519653
      ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/25.2.9519653

    steps:
      # =========================================
      # æ­¥éª¤1ï¼šæ‹‰å–ä»£ç 
      # =========================================
      - name: Checkout code
        uses: actions/checkout@v4

      # =========================================
      # æ­¥éª¤2ï¼šè®¾ç½®JDK 17
      # =========================================
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # =========================================
      # æ­¥éª¤3ï¼šè®¾ç½®Android SDKåŸºç¡€çŽ¯å¢ƒ
      # =========================================
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true

      # =========================================
      # æ­¥éª¤4ï¼šã€å…³é”®ä¿®å¤â‘ ã€‘å†™å…¥å®Œæ•´çš„SDKè®¸å¯æ–‡ä»¶
      # ä¿®å¤é—®é¢˜ï¼šthe license is not accepted
      # è¯´æ˜Žï¼šå†™å…¥æ‰€æœ‰å·²çŸ¥çš„è®¸å¯hashï¼Œè¦†ç›–æ‰€æœ‰SDKç‰ˆæœ¬
      # =========================================
      - name: Write All SDK License Files
        run: |
          echo "ðŸ“œ Writing comprehensive SDK license files..."
          mkdir -p $ANDROID_SDK_ROOT/licenses
          
          # android-sdk-licenseï¼ˆåŒ…å«æ‰€æœ‰å·²çŸ¥hashï¼‰
          cat > $ANDROID_SDK_ROOT/licenses/android-sdk-license << 'EOF'
          8933bad161af4178b1185d1a37fbf41ea5269c55
          d56f5187479451eabf01fb78af6dfcb131a6481e
          24333f8a63b6825ea9c5514f83c2829b004d1fee
          e6b7c2ab7fa2298c15165e9583d0acf0b04a2232
          EOF
          
          # android-sdk-preview-license
          cat > $ANDROID_SDK_ROOT/licenses/android-sdk-preview-license << 'EOF'
          84831b9409646a918e30573bab4c9c91346d8abd
          504667f4c0de7af1a06de9f4b1727b84351f2910
          EOF
          
          # android-googletv-license
          cat > $ANDROID_SDK_ROOT/licenses/android-googletv-license << 'EOF'
          601085b94cd77f0b54ff86406957099ebe79c4d6
          EOF
          
          # android-sdk-arm-dbt-license
          cat > $ANDROID_SDK_ROOT/licenses/android-sdk-arm-dbt-license << 'EOF'
          859f317696f67ef3d7f30a50a5560e7834b43903
          EOF
          
          # google-gdk-license
          cat > $ANDROID_SDK_ROOT/licenses/google-gdk-license << 'EOF'
          33b6a2b64607f11b759f320ef9dff4ae5c47d97a
          EOF
          
          # intel-android-extra-license
          cat > $ANDROID_SDK_ROOT/licenses/intel-android-extra-license << 'EOF'
          d975f751698a77b662f1254ddbeed3901e976f5a
          EOF
          
          # mips-android-sysimage-license
          cat > $ANDROID_SDK_ROOT/licenses/mips-android-sysimage-license << 'EOF'
          e9acab5b5fbb560a72cfaecce8946896ff6aab9d
          EOF
          
          echo "âœ… All license files written!"
          echo "ðŸ“‹ License directory:"
          ls -la $ANDROID_SDK_ROOT/licenses/

      # =========================================
      # æ­¥éª¤5ï¼šã€å…³é”®ä¿®å¤â‘¡ã€‘å®‰è£…æ‰€æœ‰å¯èƒ½éœ€è¦çš„build-toolsç‰ˆæœ¬
      # ä¿®å¤é—®é¢˜ï¼šaapt not found, Build-tools 34.1 æœªè¢«å®‰è£…
      # è¯´æ˜Žï¼šå®‰è£…å¤šä¸ªç‰ˆæœ¬ç¡®ä¿è¦†ç›–Buildozerçš„æ‰€æœ‰éœ€æ±‚
      # =========================================
      - name: Install Android SDK Components (All Versions)
        run: |
          echo "ðŸ“¦ Installing Android SDK components (multiple versions)..."
          
          # å†æ¬¡æŽ¥å—è®¸å¯ï¼ˆç¡®ä¿ç”Ÿæ•ˆï¼‰
          yes | sdkmanager --licenses || true
          
          # å®‰è£…platform-tools
          sdkmanager "platform-tools"
          
          # å®‰è£…platforms
          sdkmanager "platforms;android-34"
          sdkmanager "platforms;android-33"
          
          # ã€å…³é”®ã€‘å®‰è£…å¤šä¸ªç‰ˆæœ¬çš„build-toolsï¼Œç¡®ä¿è¦†ç›–Buildozeréœ€æ±‚
          sdkmanager "build-tools;34.0.0"
          sdkmanager "build-tools;33.0.2"
          sdkmanager "build-tools;33.0.0"
          
          # å®‰è£…NDK
          sdkmanager "ndk;$ANDROID_NDK_VERSION"
          
          # å®‰è£…cmakeï¼ˆå¯èƒ½éœ€è¦ï¼‰
          sdkmanager "cmake;3.22.1"
          
          echo "âœ… All SDK components installed!"

      # =========================================
      # æ­¥éª¤6ï¼šã€å…³é”®ä¿®å¤â‘¢ã€‘å°†æ‰€æœ‰build-toolsè·¯å¾„åŠ å…¥PATH
      # ä¿®å¤é—®é¢˜ï¼šaapt not found
      # =========================================
      - name: Add All Build Tools to PATH
        run: |
          echo "ðŸ”§ Adding build-tools to PATH..."
          echo "$ANDROID_SDK_ROOT/build-tools/34.0.0" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/build-tools/33.0.2" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/build-tools/33.0.0" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "âœ… PATH updated!"

      # =========================================
      # æ­¥éª¤7ï¼šã€å…³é”®ä¿®å¤â‘£ã€‘éªŒè¯aaptå­˜åœ¨
      # ä¿®å¤é—®é¢˜ï¼šç¡®ä¿aaptå¯è¢«æ‰¾åˆ°
      # =========================================
      - name: Verify aapt Installation
        run: |
          echo "ðŸ” Verifying aapt installation..."
          echo ""
          echo "=== Checking build-tools directories ==="
          ls -la $ANDROID_SDK_ROOT/build-tools/ || echo "build-tools dir not found"
          echo ""
          echo "=== Checking aapt in 34.0.0 ==="
          ls -la $ANDROID_SDK_ROOT/build-tools/34.0.0/aapt 2>/dev/null && echo "âœ… aapt found in 34.0.0" || echo "âŒ aapt NOT found in 34.0.0"
          echo ""
          echo "=== Checking aapt in 33.0.2 ==="
          ls -la $ANDROID_SDK_ROOT/build-tools/33.0.2/aapt 2>/dev/null && echo "âœ… aapt found in 33.0.2" || echo "âŒ aapt NOT found in 33.0.2"
          echo ""
          echo "=== Checking NDK ==="
          ls -la $ANDROID_SDK_ROOT/ndk/$ANDROID_NDK_VERSION/ 2>/dev/null | head -5 || echo "âŒ NDK not found"
          echo ""
          echo "=== Which aapt ==="
          which aapt || echo "aapt not in PATH yet (will be available in next step)"

      # =========================================
      # æ­¥éª¤8ï¼šè®¾ç½®PythonçŽ¯å¢ƒ
      # =========================================
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # =========================================
      # æ­¥éª¤9ï¼šå®‰è£…ç³»ç»Ÿä¾èµ–
      # =========================================
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            git \
            zip \
            unzip \
            python3-pip \
            ffmpeg \
            libsdl2-dev \
            libsdl2-image-dev \
            libsdl2-mixer-dev \
            libsdl2-ttf-dev \
            libportmidi-dev \
            libswscale-dev \
            libavformat-dev \
            libavcodec-dev \
            zlib1g-dev \
            libgstreamer1.0-dev \
            gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good \
            libgstreamer-plugins-base1.0-dev \
            libffi-dev \
            libssl-dev \
            autoconf \
            automake \
            libtool \
            pkg-config \
            wget \
            lld \
            ccache \
            cmake \
            ninja-build

      # =========================================
      # æ­¥éª¤10ï¼šå®‰è£…Pythonä¾èµ–
      # =========================================
      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install buildozer==1.5.0 cython==0.29.33 kivy==2.2.1 virtualenv

      # =========================================
      # æ­¥éª¤11ï¼šä¸‹è½½Voskæ¨¡åž‹
      # =========================================
      - name: Download Vosk Model
        run: |
          echo "ðŸ“¥ Downloading Vosk model..."
          wget -q https://alphacephei.com/vosk/models/vosk-model-small-en-us-0.15.zip
          unzip -q vosk-model-small-en-us-0.15.zip
          echo "âœ… Vosk model ready!"

      # =========================================
      # æ­¥éª¤12ï¼šã€å…³é”®ä¿®å¤â‘¤ã€‘å½»åº•æ¸…ç†Buildozerç¼“å­˜
      # ä¿®å¤é—®é¢˜ï¼šç¡®ä¿Buildozerä½¿ç”¨ç³»ç»ŸSDK
      # è¯´æ˜Žï¼šåˆ é™¤æ•´ä¸ª.buildozerç›®å½•ï¼Œå¼ºåˆ¶é‡æ–°æž„å»º
      # =========================================
      - name: Clean All Buildozer Cache
        run: |
          echo "ðŸ§¹ Completely cleaning Buildozer cache..."
          rm -rf ~/.buildozer 2>/dev/null || true
          rm -rf .buildozer 2>/dev/null || true
          echo "âœ… Buildozer cache completely cleaned!"

      # =========================================
      # æ­¥éª¤13ï¼šåˆ›å»ºç¬¦å·é“¾æŽ¥ç¡®ä¿aaptå¯è¢«æ‰¾åˆ°
      # ä¿®å¤é—®é¢˜ï¼šæŸäº›æƒ…å†µä¸‹Buildozeræ‰¾ä¸åˆ°aapt
      # =========================================
      - name: Create aapt Symlinks
        run: |
          echo "ðŸ”— Creating aapt symlinks..."
          sudo ln -sf $ANDROID_SDK_ROOT/build-tools/34.0.0/aapt /usr/local/bin/aapt 2>/dev/null || true
          sudo ln -sf $ANDROID_SDK_ROOT/build-tools/34.0.0/aapt2 /usr/local/bin/aapt2 2>/dev/null || true
          sudo ln -sf $ANDROID_SDK_ROOT/build-tools/34.0.0/zipalign /usr/local/bin/zipalign 2>/dev/null || true
          sudo ln -sf $ANDROID_SDK_ROOT/build-tools/34.0.0/apksigner /usr/local/bin/apksigner 2>/dev/null || true
          echo "âœ… Symlinks created!"
          which aapt && echo "aapt is now accessible!"

      # =========================================
      # æ­¥éª¤14ï¼šæž„å»ºAPK
      # è¯´æ˜Žï¼šä¼ å…¥æ‰€æœ‰å¿…è¦çš„çŽ¯å¢ƒå˜é‡
      # =========================================
      - name: Build APK with Buildozer
        run: |
          echo "ðŸ”¨ Building Android APK..."
          echo "================================================"
          echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
          echo "ANDROID_NDK_HOME: $ANDROID_NDK_HOME"
          echo "aapt location: $(which aapt || echo 'checking PATH...')"
          echo "================================================"
          echo ""
          echo "This may take 15-30 minutes on first build..."
          echo ""
          
          # æž„å»ºAPK
          buildozer -v android debug
        env:
          BUILDOZER_WARN_ON_ROOT: 0
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
          ANDROID_HOME: ${{ env.ANDROID_SDK_ROOT }}
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
          ANDROIDSDK: ${{ env.ANDROID_SDK_ROOT }}
          ANDROIDNDK: ${{ env.ANDROID_NDK_HOME }}
          ANDROIDAPI: "33"
          ANDROIDMINAPI: "24"
          # å¼ºåˆ¶æŒ‡å®šbuild-toolsè·¯å¾„
          PATH: ${{ env.ANDROID_SDK_ROOT }}/build-tools/34.0.0:${{ env.ANDROID_SDK_ROOT }}/build-tools/33.0.2:${{ env.ANDROID_SDK_ROOT }}/platform-tools:/usr/local/bin:/usr/bin:/bin

      # =========================================
      # æ­¥éª¤15ï¼šä¸Šä¼ APKäº§ç‰©
      # =========================================
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: teleprompter-apk
          path: bin/*.apk
          retention-days: 30
          if-no-files-found: error

      # =========================================
      # æ­¥éª¤16ï¼šæž„å»ºæ‘˜è¦
      # =========================================
      - name: Build Summary
        if: always()
        run: |
          echo "## ðŸ“± Build Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if ls bin/*.apk 1>/dev/null 2>&1; then
            echo "### âœ… APK Generated Successfully!" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            ls -lh bin/*.apk >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ APK Generation Failed" >> $GITHUB_STEP_SUMMARY
            echo "Check the build logs for details." >> $GITHUB_STEP_SUMMARY
          fi
