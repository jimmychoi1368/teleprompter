# =============================================================================
# GitHub Actions - Android APK Build (v6.0 极简版)
# =============================================================================
# 修复：JDK17缺JAXB、旧版tools不兼容、符号链接冲突、日志未生成
# 步骤数：12步 | 行数：<180行
# =============================================================================
name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      ANDROID_HOME: /usr/local/lib/android/sdk
      ANDROID_NDK_VERSION: 25.2.9519653

    steps:
      # 步骤1：拉取代码
      - name: Checkout
        uses: actions/checkout@v4

      # 步骤2：设置Python 3.10
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 步骤3：设置JDK 11（修复JAXB缺失问题）
      - name: Setup JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      # 步骤4：验证Java版本
      - name: Verify Java
        run: java -version

      # 步骤5：设置Android SDK
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true

      # 步骤6：修复SDK + 安装组件
      - name: Fix SDK and Install Components
        run: |
          rm -rf $ANDROID_SDK_ROOT/tools
          yes | sdkmanager --licenses || true
          sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.2" "ndk;$ANDROID_NDK_VERSION"
          mkdir -p $ANDROID_SDK_ROOT/licenses
          echo -e "\n8933bad161af4178b1185d1a37fbf41ea5269c55\nd56f5187479451eabf01fb78af6dfcb131a6481e" > $ANDROID_SDK_ROOT/licenses/android-sdk-license

      # 步骤7：安装系统依赖（含SSL修复）
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git zip unzip python3-pip python3-dev libssl-dev \
            libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev libportmidi-dev \
            libswscale-dev libavformat-dev libavcodec-dev zlib1g-dev libffi-dev \
            libgstreamer1.0-dev gstreamer1.0-plugins-base libgstreamer-plugins-base1.0-dev \
            autoconf automake libtool cmake ccache lld wget

      # 步骤8：安装Python依赖
      - name: Install Python Dependencies
        run: |
          pip install --upgrade pip wheel setuptools
          pip install buildozer==1.5.0 cython==0.29.33 kivy==2.2.1

      # 步骤9：下载Vosk模型
      - name: Download Vosk Model
        run: |
          wget -q https://alphacephei.com/vosk/models/vosk-model-small-en-us-0.15.zip
          unzip -q vosk-model-small-en-us-0.15.zip

      # 步骤10：配置Buildozer SDK（修复符号链接冲突）
      - name: Setup Buildozer SDK
        run: |
          rm -rf ~/.buildozer .buildozer
          mkdir -p ~/.buildozer/android/platform
          ln -sf $ANDROID_SDK_ROOT ~/.buildozer/android/platform/android-sdk

      # 步骤11：构建APK（强制生成日志）
      - name: Build APK
        id: build
        run: |
          export PATH="$ANDROID_SDK_ROOT/build-tools/33.0.2:$ANDROID_SDK_ROOT/platform-tools:$PATH"
          buildozer android debug --verbose 2>&1 | tee buildozer-final.log || true
          if ls bin/*.apk 1>/dev/null 2>&1; then
            echo "apk_exists=true" >> $GITHUB_OUTPUT
          else
            echo "apk_exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          BUILDOZER_WARN_ON_ROOT: 0

      # 步骤12：上传日志和APK
      - name: Upload Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: buildozer-final.log
          if-no-files-found: warn

      - name: Upload APK
        if: steps.build.outputs.apk_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: teleprompter-apk
          path: bin/*.apk

      - name: Result
        if: always()
        run: |
          if [ "${{ steps.build.outputs.apk_exists }}" == "true" ]; then
            echo "✅ APK生成成功"; ls -lh bin/*.apk
          else
            echo "❌ 构建失败，请下载build-log查看"; exit 1
          fi
