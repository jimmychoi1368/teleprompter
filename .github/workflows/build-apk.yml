# =============================================================================
# GitHub Actions - è‡ªåŠ¨æ‰“åŒ… Android APK
# =============================================================================
# ã€é‡è¦å£°æ˜Žã€‘æœ¬é…ç½®æ–‡ä»¶ä»…å±žäºŽã€Œteleprompterã€ä»“åº“ï¼
# ä¸ŽçŽ°æœ‰ç½‘ç«™ä»“åº“æ— ä»»ä½•ä»£ç /é…ç½®äº¤é›†ï¼Œæ— å†²çªé£Žé™©ï¼
#
# è§¦å‘æ¡ä»¶ï¼š
# - æŽ¨é€åˆ°mainåˆ†æ”¯
# - æ‰‹åŠ¨è§¦å‘ï¼ˆworkflow_dispatchï¼‰
#
# è¾“å‡ºï¼šAndroid APKæ–‡ä»¶ï¼ˆARM64æž¶æž„ï¼‰
# =============================================================================

name: Build Android APK

on:
  # æŽ¨é€åˆ°mainåˆ†æ”¯æ—¶è‡ªåŠ¨æž„å»º
  push:
    branches:
      - main
  
  # å…è®¸æ‰‹åŠ¨è§¦å‘æž„å»º
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'Enable debug mode'
        required: false
        default: 'false'

env:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
      # =========================================
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      # =========================================
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      # =========================================
      # æ­¥éª¤2: å®‰è£…Android SDKå‘½ä»¤è¡Œå·¥å…·
      # =========================================
      - name: Install Android SDK Command Line Tools
        run: |
          echo "ðŸ“¦ Installing Android SDK Command Line Tools..."
          sudo apt-get update
          sudo apt-get install -y android-sdk
          echo "âœ… Android SDK Command Line Tools installed!"
      
      # =========================================
      # æ­¥éª¤3: è®¾ç½®Android SDKçŽ¯å¢ƒå˜é‡
      # =========================================
      - name: Setup Android SDK Environment
        run: |
          echo "ðŸ”§ Setting up Android SDK environment..."
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
          echo "âœ… Android SDK environment configured!"
      
      # =========================================
      # æ­¥éª¤4: æŽ¥å—Android SDKè®¸å¯
      # =========================================
      - name: Accept Android SDK licenses
        run: |
          echo "ðŸ“œ Accepting Android SDK licenses..."
          yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses
          echo "âœ… SDK licenses accepted!"
      
      # =========================================
      # æ­¥éª¤5: å®‰è£…build-tools
      # =========================================
      - name: Install Android build-tools
        run: |
          echo "ðŸ“¥ Installing Android build-tools..."
          $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "build-tools;34.0.0"
          echo "âœ… build-tools installed!"
      
      # =========================================
      # æ­¥éª¤6: è®¾ç½®PythonçŽ¯å¢ƒ
      # =========================================
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      # =========================================
      # æ­¥éª¤7: å®‰è£…ç³»ç»Ÿä¾èµ–
      # =========================================
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-pip \
            build-essential \
            git \
            ffmpeg \
            libsdl2-dev \
            libsdl2-image-dev \
            libsdl2-mixer-dev \
            libsdl2-ttf-dev \
            libportmidi-dev \
            libswscale-dev \
            libavformat-dev \
            libavcodec-dev \
            zlib1g-dev \
            libgstreamer1.0-dev \
            gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good \
            libgstreamer-plugins-base1.0-dev \
            libffi-dev \
            libssl-dev \
            autoconf \
            automake \
            libtool \
            pkg-config \
            zip \
            unzip \
            openjdk-17-jdk \
            wget \
            lld
      
      # =========================================
      # æ­¥éª¤8: å®‰è£…Pythonä¾èµ–
      # =========================================
      - name: Install Python Dependencies
        run: |
          pip install --upgrade pip
          pip install \
            buildozer \
            cython==0.29.33 \
            virtualenv \
            kivy==2.2.1
      
      # =========================================
      # æ­¥éª¤9: ä¸‹è½½Voskæ¨¡åž‹
      # =========================================
      - name: Download Vosk Model
        run: |
          echo "ðŸ“¥ Downloading Vosk English Model..."
          wget -q https://alphacephei.com/vosk/models/vosk-model-small-en-us-0.15.zip
          unzip -q vosk-model-small-en-us-0.15.zip
          echo "âœ… Vosk model downloaded successfully!"
      
      # =========================================
      # æ­¥éª¤10: é…ç½®Buildozerç¼“å­˜
      # =========================================
      - name: Cache Buildozer
        uses: actions/cache@v4
        with:
          path: |
            ~/.buildozer
            .buildozer
          key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}
          restore-keys: |
            ${{ runner.os }}-buildozer-
      
      # =========================================
      # æ­¥éª¤11: åˆå§‹åŒ–Buildozer
      # =========================================
      - name: Initialize Buildozer
        run: |
          echo "ðŸ”§ Initializing Buildozer..."
          yes | buildozer android licenses || true
      
      # =========================================
      # æ­¥éª¤12: æž„å»ºAPK
      # =========================================
      - name: Build APK
        run: |
          echo "ðŸ”¨ Building Android APK..."
          echo "This may take 15-30 minutes on first build..."
          buildozer -v android debug
        env:
          BUILDOZER_WARN_ON_ROOT: 0
          ANDROID_HOME: ${{ env.ANDROID_SDK_ROOT }}
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
      
      # =========================================
      # æ­¥éª¤13: ä¸Šä¼ APKäº§ç‰©
      # =========================================
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: teleprompter-apk
          path: bin/*.apk
          retention-days: 30
      
      # =========================================
      # æ­¥éª¤14: æž„å»ºæ‘˜è¦
      # =========================================
      - name: Build Summary
        run: |
          echo "## ðŸŽ‰ Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± APK Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ls -lh bin/*.apk >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "APK files listed above"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Download" >> $GITHUB_STEP_SUMMARY
          echo "Download the APK from the **Artifacts** section above." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Notes" >> $GITHUB_STEP_SUMMARY
          echo "- This APK is a **debug build**" >> $GITHUB_STEP_SUMMARY
          echo "- Supports **ARM64** devices" >> $GITHUB_STEP_SUMMARY
          echo "- Requires **Android 7.0+** (API 24)" >> $GITHUB_STEP_SUMMARY
