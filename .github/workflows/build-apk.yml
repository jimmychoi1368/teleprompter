# =============================================================================
# GitHub Actions - è‡ªåŠ¨æ‰“åŒ… Android APKï¼ˆç»ˆæžè§£å†³æ–¹æ¡ˆ v2.0ï¼‰
# =============================================================================
# ã€é‡è¦å£°æ˜Žã€‘æœ¬é…ç½®æ–‡ä»¶ä»…å±žäºŽã€Œteleprompterã€ä»“åº“ï¼
# ä¸ŽçŽ°æœ‰ç½‘ç«™ä»“åº“æ— ä»»ä½•ä»£ç /é…ç½®äº¤é›†ï¼Œæ— å†²çªé£Žé™©ï¼
#
# æŠ€æœ¯æ ˆï¼šKivy + Vosk + Buildozer
#
# ã€æ ¸å¿ƒä¿®å¤ã€‘è§£å†³Buildozerä¸Žç³»ç»ŸSDKéš”ç¦»å¯¼è‡´çš„è®¸å¯é—®é¢˜ï¼š
# - buildozer.specä¸­æ·»åŠ android.sdk_path/android.ndk_pathå¼ºåˆ¶ä½¿ç”¨ç³»ç»ŸSDK
# - æœ¬é…ç½®ç¡®ä¿ç³»ç»ŸSDKæ­£ç¡®å®‰è£…å¹¶æŽ¥å—è®¸å¯
#
# è§¦å‘æ¡ä»¶ï¼šæŽ¨é€åˆ°mainåˆ†æ”¯ / æ‰‹åŠ¨è§¦å‘
# è¾“å‡ºï¼šAndroid APKæ–‡ä»¶ï¼ˆARM64æž¶æž„ï¼‰
# =============================================================================
name: Build Android APK
on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'Enable debug mode'
        required: false
        default: 'false'
# =============================================================================
# å…¨å±€çŽ¯å¢ƒå˜é‡ - å¿…é¡»ä¸Žbuildozer.specä¸­çš„android.sdk_path/ndk_pathä¸€è‡´ï¼
# =============================================================================
env:
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_HOME: /usr/local/lib/android/sdk
  ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/25.2.9519653
  ANDROID_NDK_VERSION: 25.2.9519653
jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
      # =========================================
      # æ­¥éª¤1: æ£€å‡ºä»£ç 
      # =========================================
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      # =========================================
      # æ­¥éª¤2: è®¾ç½®JavaçŽ¯å¢ƒï¼ˆAndroidæ‰“åŒ…å¿…éœ€ï¼‰
      # =========================================
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      # =========================================
      # æ­¥éª¤3: é…ç½®Android SDK
      # ä½œç”¨ï¼šä½¿ç”¨å®˜æ–¹Actionå®‰è£…SDKå¹¶è‡ªåŠ¨æŽ¥å—è®¸å¯
      # =========================================
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true
      
      # =========================================
      # æ­¥éª¤4: å®‰è£…SDKç»„ä»¶åˆ°ç³»ç»ŸSDKç›®å½•
      # ã€å…³é”®ã€‘è¿™äº›ç»„ä»¶å®‰è£…åˆ°buildozer.specæŒ‡å®šçš„è·¯å¾„
      # =========================================
      - name: Install Android SDK Components
        run: |
          echo "ðŸ“¦ Installing SDK components to system SDK..."
          echo "SDK Path: $ANDROID_SDK_ROOT"
          
          # å®‰è£…æ‰€æœ‰å¿…éœ€ç»„ä»¶
          sdkmanager --sdk_root=$ANDROID_SDK_ROOT "platform-tools"
          sdkmanager --sdk_root=$ANDROID_SDK_ROOT "platforms;android-33"
          sdkmanager --sdk_root=$ANDROID_SDK_ROOT "build-tools;33.0.2"
          sdkmanager --sdk_root=$ANDROID_SDK_ROOT "ndk;$ANDROID_NDK_VERSION"
          
          echo "âœ… SDK components installed!"
      
      # =========================================
      # æ­¥éª¤5: ç¡®ä¿SDKè®¸å¯æ–‡ä»¶å­˜åœ¨
      # ã€å…³é”®ã€‘åŒé‡ä¿éšœï¼šå³ä½¿Actionå·²æŽ¥å—ï¼Œä»æ‰‹åŠ¨å†™å…¥
      # =========================================
      - name: Ensure SDK License Files
        run: |
          echo "ðŸ“œ Ensuring SDK license files..."
          mkdir -p $ANDROID_SDK_ROOT/licenses
          
          # å†™å…¥æ‰€æœ‰å·²çŸ¥çš„è®¸å¯hash
          echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > $ANDROID_SDK_ROOT/licenses/android-sdk-license
          echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> $ANDROID_SDK_ROOT/licenses/android-sdk-license
          echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" >> $ANDROID_SDK_ROOT/licenses/android-sdk-license
          
          # Android SDK Preview License
          echo "84831b9409646a918e30573bab4c9c91346d8abd" > $ANDROID_SDK_ROOT/licenses/android-sdk-preview-license
          
          # NDKè®¸å¯
          mkdir -p $ANDROID_NDK_HOME
          
          echo "âœ… License files written!"
          echo "ðŸ“‹ License directory contents:"
          ls -la $ANDROID_SDK_ROOT/licenses/
      
      # =========================================
      # æ­¥éª¤6: éªŒè¯SDKé…ç½®ï¼ˆè°ƒè¯•ç”¨ï¼‰
      # =========================================
      - name: Verify SDK Configuration
        run: |
          echo "ðŸ” Verifying SDK configuration..."
          echo ""
          echo "=== Environment Variables ==="
          echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
          echo "ANDROID_HOME: $ANDROID_HOME"
          echo "ANDROID_NDK_HOME: $ANDROID_NDK_HOME"
          echo ""
          echo "=== SDK Directory Structure ==="
          ls -la $ANDROID_SDK_ROOT/
          echo ""
          echo "=== Installed Components ==="
          sdkmanager --list_installed 2>/dev/null | head -20 || true
          echo ""
          echo "=== NDK Directory ==="
          ls -la $ANDROID_SDK_ROOT/ndk/ 2>/dev/null || echo "NDK directory check"
          echo ""
          echo "=== buildozer.spec SDK Config ==="
          grep -E "android.sdk_path|android.ndk_path" buildozer.spec || echo "SDK paths not found in spec"
          echo ""
          echo "âœ… SDK verification complete!"
      
      # =========================================
      # æ­¥éª¤7: è®¾ç½®PythonçŽ¯å¢ƒ
      # =========================================
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      # =========================================
      # æ­¥éª¤8: å®‰è£…ç³»ç»Ÿä¾èµ–
      # =========================================
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            git \
            zip \
            unzip \
            python3-pip \
            ffmpeg \
            libsdl2-dev \
            libsdl2-image-dev \
            libsdl2-mixer-dev \
            libsdl2-ttf-dev \
            libportmidi-dev \
            libswscale-dev \
            libavformat-dev \
            libavcodec-dev \
            zlib1g-dev \
            libgstreamer1.0-dev \
            gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good \
            libgstreamer-plugins-base1.0-dev \
            libffi-dev \
            libssl-dev \
            autoconf \
            automake \
            libtool \
            pkg-config \
            wget \
            lld \
            ccache
      
      # =========================================
      # æ­¥éª¤9: å®‰è£…Python/Buildozerä¾èµ–
      # =========================================
      - name: Install Python Dependencies
        run: |
          pip install --upgrade pip wheel setuptools
          pip install \
            buildozer==1.5.0 \
            cython==0.29.33 \
            virtualenv \
            kivy==2.2.1
      
      # =========================================
      # æ­¥éª¤10: ä¸‹è½½Voskè¯­éŸ³æ¨¡åž‹
      # =========================================
      - name: Download Vosk Model
        run: |
          echo "ðŸ“¥ Downloading Vosk English Model..."
          wget -q https://alphacephei.com/vosk/models/vosk-model-small-en-us-0.15.zip
          unzip -q vosk-model-small-en-us-0.15.zip
          echo "âœ… Vosk model ready!"
      
      # =========================================
      # æ­¥éª¤11: é…ç½®Buildozerç¼“å­˜ + æ¸…ç†ç§æœ‰SDK
      # =========================================
      - name: Cache Buildozer
        uses: actions/cache@v4
        with:
          path: |
            ~/.buildozer
            .buildozer
          key: ${{ runner.os }}-buildozer-v2-${{ hashFiles('buildozer.spec') }}
          restore-keys: |
            ${{ runner.os }}-buildozer-v2-
      
      - name: Clean Buildozer Private SDK
        run: |
          echo "ðŸ§¹ Cleaning any cached private SDK..."
          rm -rf ~/.buildozer/android/platform/android-sdk 2>/dev/null || true
          rm -rf ~/.buildozer/android/platform/android-ndk* 2>/dev/null || true
          echo "âœ… Private SDK cleaned!"
      
      # =========================================
      # æ­¥éª¤12: æž„å»ºAPK
      # ã€æ ¸å¿ƒã€‘Buildozerå°†ä½¿ç”¨buildozer.specä¸­æŒ‡å®šçš„ç³»ç»ŸSDKè·¯å¾„
      # =========================================
      - name: Build APK
        run: |
          echo "ðŸ”¨ Building Android APK..."
          echo "================================================"
          echo "SDK Path (from buildozer.spec): /usr/local/lib/android/sdk"
          echo "NDK Path (from buildozer.spec): /usr/local/lib/android/sdk/ndk/$ANDROID_NDK_VERSION"
          echo "================================================"
          echo ""
          echo "This may take 15-30 minutes on first build..."
          echo ""
          
          # æž„å»ºAPK
          buildozer -v android debug
        env:
          BUILDOZER_WARN_ON_ROOT: 0
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
          ANDROID_HOME: ${{ env.ANDROID_HOME }}
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
          ANDROIDSDK: ${{ env.ANDROID_SDK_ROOT }}
          ANDROIDNDK: ${{ env.ANDROID_NDK_HOME }}
      
      # =========================================
      # æ­¥éª¤13: ä¸Šä¼ APK
      # =========================================
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: teleprompter-apk
          path: bin/*.apk
          retention-days: 30
          if-no-files-found: error
      
      # =========================================
      # æ­¥éª¤14: æž„å»ºæ‘˜è¦
      # =========================================
      - name: Build Summary
        if: always()
        run: |
          echo "## ðŸŽ‰ Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if ls bin/*.apk 1>/dev/null 2>&1; then
            echo "### âœ… APK Generated Successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            ls -lh bin/*.apk >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ APK Generation Failed" >> $GITHUB_STEP_SUMMARY
            echo "Check the build logs for details." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Build Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **SDK Path:** /usr/local/lib/android/sdk" >> $GITHUB_STEP_SUMMARY
          echo "- **NDK Version:** $ANDROID_NDK_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Target API:** 33" >> $GITHUB_STEP_SUMMARY
          echo "- **Min API:** 24 (Android 7.0+)" >> $GITHUB_STEP_SUMMARY
          echo "- **Architecture:** ARM64" >> $GITHUB_STEP_SUMMARY