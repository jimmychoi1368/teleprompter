# =============================================================================
# GitHub Actions workflow for building Android APK with Buildozer
# =============================================================================
# ã€é‡è¦å£°æ˜ã€‘æœ¬é…ç½®æ–‡ä»¶ä»…å±äºã€Œteleprompterã€ä»“åº“
# 
# ã€v4.0 - è°ƒè¯•ä¼˜å…ˆç‰ˆã€‘
# æ ¸å¿ƒç›®æ ‡ï¼šè¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼Œå®šä½Build APKæ­¥éª¤å¤±è´¥çš„çœŸæ­£åŸå› 
# =============================================================================
name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      ANDROID_HOME: /usr/local/lib/android/sdk
      ANDROID_NDK_VERSION: 25.2.9519653
      ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/25.2.9519653

    steps:
      # =========================================
      # æ­¥éª¤1ï¼šæ‹‰å–ä»£ç 
      # =========================================
      - name: Checkout code
        uses: actions/checkout@v4

      # =========================================
      # æ­¥éª¤2ï¼šæ˜¾ç¤ºé¡¹ç›®ç»“æ„ï¼ˆè°ƒè¯•ï¼‰
      # ç›®çš„ï¼šç¡®è®¤ä»£ç å’Œæ–‡ä»¶æ˜¯å¦æ­£ç¡®æ‹‰å–
      # =========================================
      - name: Show Project Structure
        run: |
          echo "ğŸ“ Project structure:"
          ls -la
          echo ""
          echo "ğŸ“„ buildozer.spec content:"
          cat buildozer.spec
          echo ""
          echo "ğŸ“„ main.py exists:"
          ls -la main.py || echo "main.py NOT FOUND!"
          echo ""
          echo "ğŸ“‹ Key buildozer.spec settings:"
          grep -E "source.include|requirements|android.ndk" buildozer.spec || true

      # =========================================
      # æ­¥éª¤3ï¼šè®¾ç½®JDK 17
      # =========================================
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # =========================================
      # æ­¥éª¤4ï¼šè®¾ç½®Pythonç¯å¢ƒ
      # =========================================
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # =========================================
      # æ­¥éª¤5ï¼šè®¾ç½®Android SDK
      # =========================================
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true

      # =========================================
      # æ­¥éª¤6ï¼šå…¨é¢æ¥å—SDKè®¸å¯
      # =========================================
      - name: Accept All SDK Licenses
        run: |
          echo "ğŸ“œ Accepting all SDK licenses..."
          yes | sdkmanager --licenses || true
          
          mkdir -p $ANDROID_SDK_ROOT/licenses
          echo -e "\n8933bad161af4178b1185d1a37fbf41ea5269c55" > $ANDROID_SDK_ROOT/licenses/android-sdk-license
          echo -e "\nd56f5187479451eabf01fb78af6dfcb131a6481e" >> $ANDROID_SDK_ROOT/licenses/android-sdk-license
          echo -e "\n24333f8a63b6825ea9c5514f83c2829b004d1fee" >> $ANDROID_SDK_ROOT/licenses/android-sdk-license
          echo -e "\n84831b9409646a918e30573bab4c9c91346d8abd" > $ANDROID_SDK_ROOT/licenses/android-sdk-preview-license
          
          echo "âœ… Licenses accepted!"

      # =========================================
      # æ­¥éª¤7ï¼šå®‰è£…SDKç»„ä»¶
      # ã€ä¿®å¤v3ã€‘ç‰ˆæœ¬å¿…é¡»ä¸buildozer.specå®Œå…¨ä¸€è‡´ï¼
      # buildozer.specé…ç½®ï¼šandroid.api = 33, android.build_tools = 33.0.2
      # =========================================
      - name: Install SDK Components
        run: |
          echo "ğŸ“¦ Installing SDK components..."
          echo ""
          echo "ã€å…³é”®ã€‘ç‰ˆæœ¬å¿…é¡»ä¸buildozer.specä¸€è‡´ï¼š"
          echo "  - android.api = 33 â†’ éœ€è¦ platforms;android-33"
          echo "  - android.build_tools = 33.0.2 â†’ éœ€è¦ build-tools;33.0.2"
          echo ""
          
          # å†æ¬¡æ¥å—æ‰€æœ‰è®¸å¯
          yes | sdkmanager --licenses || true
          
          # å®‰è£…platform-tools
          sdkmanager "platform-tools"
          
          # ã€å…³é”®ã€‘å®‰è£…platforms;android-33ï¼ˆå¿…é¡»ä¸android.api = 33ä¸€è‡´ï¼‰
          echo "ğŸ“¦ Installing platforms..."
          sdkmanager "platforms;android-33"
          echo "âœ“ platforms;android-33 installed"
          
          # ã€å…³é”®ã€‘å®‰è£…build-tools;33.0.2ï¼ˆå¿…é¡»ä¸android.build_tools = 33.0.2ä¸€è‡´ï¼‰
          echo "ğŸ“¦ Installing build-tools..."
          sdkmanager "build-tools;33.0.2"
          echo "âœ“ build-tools;33.0.2 installed"
          
          # å¤‡ç”¨ç‰ˆæœ¬ï¼ˆä»¥é˜²python-for-androidè¯·æ±‚å…¶ä»–ç‰ˆæœ¬ï¼‰
          sdkmanager "build-tools;34.0.0" || true
          sdkmanager "build-tools;35.0.0" || true
          
          # å®‰è£…NDK
          sdkmanager "ndk;$ANDROID_NDK_VERSION"
          
          echo ""
          echo "âœ… SDK components installation complete!"
          echo ""
          echo "ğŸ“‹ Installed platforms versions:"
          ls -la $ANDROID_SDK_ROOT/platforms/
          echo ""
          echo "ğŸ“‹ Installed build-tools versions:"
          ls -la $ANDROID_SDK_ROOT/build-tools/
          echo ""
          echo "ğŸ“‹ Build-tools 33.0.2 contents:"
          ls -la $ANDROID_SDK_ROOT/build-tools/33.0.2/ | head -10

      # =========================================
      # æ­¥éª¤8ï¼šé…ç½®ç¯å¢ƒå˜é‡å’ŒPATH
      # ã€ä¿®å¤ã€‘ä½¿ç”¨33.0.2ç‰ˆæœ¬ï¼ˆä¸buildozer.specä¸€è‡´ï¼‰
      # =========================================
      - name: Configure Environment
        run: |
          echo "ğŸ”§ Configuring environment..."
          
          # æ·»åŠ build-tools 33.0.2åˆ°PATHï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
          echo "$ANDROID_SDK_ROOT/build-tools/33.0.2" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
          
          # åˆ›å»ºç¬¦å·é“¾æ¥ï¼ˆä½¿ç”¨33.0.2ç‰ˆæœ¬ï¼‰
          sudo ln -sf $ANDROID_SDK_ROOT/build-tools/33.0.2/aapt /usr/local/bin/aapt
          sudo ln -sf $ANDROID_SDK_ROOT/build-tools/33.0.2/aapt2 /usr/local/bin/aapt2
          sudo ln -sf $ANDROID_SDK_ROOT/build-tools/33.0.2/aidl /usr/local/bin/aidl
          
          echo "âœ… Environment configured!"
          echo ""
          echo "ğŸ“‹ Symlinks created:"
          ls -la /usr/local/bin/aapt /usr/local/bin/aapt2 /usr/local/bin/aidl 2>/dev/null || true

      # =========================================
      # æ­¥éª¤9ï¼šå®‰è£…ç³»ç»Ÿä¾èµ–
      # ã€å…³é”®ã€‘ç¡®ä¿æ‰€æœ‰Kivyç¼–è¯‘ä¾èµ–éƒ½å®‰è£…
      # ã€ä¿®å¤ã€‘ç§»é™¤Ubuntu 22.04+ä¸å¯ç”¨çš„åŒ…ï¼š
      #   - libtinfo5 â†’ å·²è¢«libtinfo6æ›¿ä»£ï¼Œä¸éœ€è¦å•ç‹¬å®‰è£…
      #   - libncurses5-dev â†’ ä½¿ç”¨libncurses-devæ›¿ä»£
      # =========================================
      - name: Install System Dependencies
        run: |
          echo "ğŸ“¦ Installing system dependencies..."
          echo "System info: $(lsb_release -a 2>/dev/null || cat /etc/os-release)"
          echo ""
          
          # æ›´æ–°åŒ…åˆ—è¡¨
          sudo apt-get update
          
          # å®‰è£…æ ¸å¿ƒä¾èµ–ï¼ˆå·²éªŒè¯åœ¨Ubuntu 22.04/24.04å¯ç”¨ï¼‰
          sudo apt-get install -y \
            build-essential \
            git \
            zip \
            unzip \
            python3-pip \
            python3-dev \
            ffmpeg \
            libsdl2-dev \
            libsdl2-image-dev \
            libsdl2-mixer-dev \
            libsdl2-ttf-dev \
            libportmidi-dev \
            libswscale-dev \
            libavformat-dev \
            libavcodec-dev \
            libavdevice-dev \
            zlib1g-dev \
            libgstreamer1.0-dev \
            gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good \
            libgstreamer-plugins-base1.0-dev \
            libffi-dev \
            libssl-dev \
            autoconf \
            automake \
            libtool \
            pkg-config \
            wget \
            lld \
            ccache \
            cmake \
            ninja-build \
            libltdl-dev \
            libncurses-dev \
            libncursesw5-dev \
            patch \
            ant \
            openjdk-17-jdk
          
          echo ""
          echo "âœ… System dependencies installed!"
          
          # éªŒè¯å…³é”®ä¾èµ–
          echo ""
          echo "ğŸ“‹ Verifying installed packages:"
          dpkg -l | grep -E "libsdl2|libncurses|autoconf" | head -10 || true

      # =========================================
      # æ­¥éª¤10ï¼šå®‰è£…Pythonä¾èµ–
      # =========================================
      - name: Install Python Dependencies
        run: |
          echo "ğŸ“¦ Installing Python dependencies..."
          python -m pip install --upgrade pip wheel setuptools
          pip install buildozer==1.5.0
          pip install cython==0.29.33
          pip install kivy==2.2.1
          pip install virtualenv
          
          echo ""
          echo "ğŸ“‹ Installed Python packages:"
          pip list | grep -E "buildozer|cython|kivy"

      # =========================================
      # æ­¥éª¤11ï¼šä¸‹è½½å¹¶é…ç½®Voskæ¨¡å‹
      # ã€å…³é”®ä¿®å¤ã€‘ç¡®ä¿æ¨¡å‹åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼Œä¸main.pyåŒçº§
      # =========================================
      - name: Download and Setup Vosk Model
        run: |
          echo "ğŸ“¥ Downloading Vosk model..."
          
          # ä¸‹è½½æ¨¡å‹
          wget -q https://alphacephei.com/vosk/models/vosk-model-small-en-us-0.15.zip
          unzip -q vosk-model-small-en-us-0.15.zip
          
          # éªŒè¯æ¨¡å‹å­˜åœ¨ä¸”åœ¨æ­£ç¡®ä½ç½®ï¼ˆé¡¹ç›®æ ¹ç›®å½•ï¼‰
          echo ""
          echo "ğŸ“ Project root contents:"
          ls -la
          echo ""
          echo "ğŸ“ Vosk model structure:"
          ls -la vosk-model-small-en-us-0.15/ | head -20
          echo ""
          echo "ğŸ“ Vosk model files count:"
          find vosk-model-small-en-us-0.15 -type f | wc -l
          
          echo "âœ… Vosk model ready in project root!"

      # =========================================
      # æ­¥éª¤12ï¼šé¢„é…ç½®Buildozerçš„SDKç›®å½•
      # ã€ä¿®å¤v2ã€‘åˆ›å»ºå®Œæ•´çš„ç›®å½•ç»“æ„å¹¶ç¡®ä¿Buildozerèƒ½æ‰¾åˆ°æ‰€æœ‰å·¥å…·
      # =========================================
      - name: Setup Buildozer SDK Directory
        run: |
          echo "ğŸ”§ Setting up Buildozer SDK directory..."
          
          # ã€é‡è¦ã€‘å½»åº•æ¸…ç†æ‰€æœ‰Buildozerç¼“å­˜ï¼Œé¿å…ä½¿ç”¨æ—§é…ç½®
          rm -rf ~/.buildozer 2>/dev/null || true
          rm -rf .buildozer 2>/dev/null || true
          rm -rf ~/.android 2>/dev/null || true
          
          # åˆ›å»ºBuildozeræœŸæœ›çš„å®Œæ•´ç›®å½•ç»“æ„
          mkdir -p ~/.buildozer/android/platform
          
          # ã€å…³é”®ã€‘åˆ›å»ºç¬¦å·é“¾æ¥ï¼Œè®©Buildozerä½¿ç”¨ç³»ç»ŸSDK
          ln -sf $ANDROID_SDK_ROOT ~/.buildozer/android/platform/android-sdk
          
          # åŒæ—¶åˆ›å»ºNDKç¬¦å·é“¾æ¥
          mkdir -p ~/.buildozer/android/platform/android-ndk
          ln -sf $ANDROID_NDK_HOME ~/.buildozer/android/platform/android-ndk-r25c || true
          
          # éªŒè¯ç¬¦å·é“¾æ¥æ˜¯å¦æ­£ç¡®
          echo ""
          echo "ğŸ“ Buildozer SDK directory structure:"
          ls -la ~/.buildozer/android/platform/
          echo ""
          echo "ğŸ“ Linked SDK contents:"
          ls -la ~/.buildozer/android/platform/android-sdk/ | head -10
          echo ""
          echo "ğŸ“ Linked SDK build-tools:"
          ls -la ~/.buildozer/android/platform/android-sdk/build-tools/
          echo ""
          
          # ã€éªŒè¯ã€‘ç¡®ä¿aaptå’Œaidlå­˜åœ¨
          LATEST_BT=$(ls -d $ANDROID_SDK_ROOT/build-tools/* 2>/dev/null | sort -V | tail -1)
          echo "ğŸ“‹ Latest build-tools: $LATEST_BT"
          echo "ğŸ“‹ aapt location: $(ls $LATEST_BT/aapt 2>/dev/null || echo 'NOT FOUND')"
          echo "ğŸ“‹ aidl location: $(ls $LATEST_BT/aidl 2>/dev/null || echo 'NOT FOUND')"
          
          echo "âœ… Buildozer SDK directory configured!"

      # =========================================
      # æ­¥éª¤13ï¼šéªŒè¯æ„å»ºç¯å¢ƒï¼ˆè¯¦ç»†ç‰ˆï¼‰
      # =========================================
      - name: Verify Build Environment
        run: |
          echo "ğŸ” Verifying build environment..."
          echo ""
          echo "=== Java Version ==="
          java -version
          echo ""
          echo "=== Python Version ==="
          python --version
          echo ""
          echo "=== Buildozer Version ==="
          buildozer --version
          pip show buildozer | grep -E "Name|Version"
          echo ""
          echo "=== Android SDK ==="
          echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
          echo "ANDROID_HOME: $ANDROID_HOME"
          echo "ANDROID_NDK_HOME: $ANDROID_NDK_HOME"
          echo ""
          echo "=== Build-tools versions installed ==="
          ls -la $ANDROID_SDK_ROOT/build-tools/
          echo ""
          echo "=== æ£€æŸ¥build-tools 33.0.2çš„å…³é”®å·¥å…· ==="
          BT_DIR="$ANDROID_SDK_ROOT/build-tools/33.0.2"
          echo "--- 33.0.2 ---"
          ls $BT_DIR/aapt 2>/dev/null && echo "  âœ“ aapt exists" || echo "  âœ— aapt missing"
          ls $BT_DIR/aapt2 2>/dev/null && echo "  âœ“ aapt2 exists" || echo "  âœ— aapt2 missing"
          ls $BT_DIR/aidl 2>/dev/null && echo "  âœ“ aidl exists" || echo "  âœ— aidl missing"
          ls $BT_DIR/dx 2>/dev/null && echo "  âœ“ dx exists" || echo "  âœ— dx missing (å¯èƒ½ç”¨d8æ›¿ä»£)"
          ls $BT_DIR/d8 2>/dev/null && echo "  âœ“ d8 exists" || echo "  âœ— d8 missing"
          echo ""
          echo "=== Buildozerç¬¦å·é“¾æ¥éªŒè¯ ==="
          ls -la ~/.buildozer/android/platform/ 2>/dev/null || echo "Buildozer platform dir not found"
          ls -la ~/.buildozer/android/platform/android-sdk/build-tools/ 2>/dev/null || echo "Linked build-tools not found"
          echo ""
          echo "=== buildozer.specå…³é”®é…ç½®ï¼ˆåŸå§‹æ–‡ä»¶ï¼‰ ==="
          echo "ã€è¿™äº›é…ç½®å¿…é¡»è¢«Buildozeræ­£ç¡®è¯»å–ã€‘"
          grep -E "^android\.(api|build_tools|ndk|sdk_path|ndk_path)" buildozer.spec || true
          grep -E "^requirements" buildozer.spec || true
          echo ""
          echo "=== Project Files ==="
          ls -la
          echo ""
          echo "=== Vosk Model Check ==="
          ls -la vosk-model-small-en-us-0.15/ 2>/dev/null | head -5 || echo "Vosk model directory not found!"
          echo ""
          echo "âœ… Environment verification complete!"

      # =========================================
      # æ­¥éª¤13.5ï¼šã€å…³é”®ã€‘éªŒè¯Buildozeré…ç½®æ˜¯å¦è¢«æ­£ç¡®è¯»å–
      # =========================================
      - name: Verify Buildozer Config Reading
        run: |
          echo "ğŸ” Verifying Buildozer reads config correctly..."
          echo ""
          echo "ã€é‡è¦ã€‘ä»¥ä¸‹è¾“å‡ºæ˜¾ç¤ºBuildozerå®é™…è¯»å–çš„é…ç½®å€¼"
          echo "å¦‚æœå€¼ä¸buildozer.specä¸ä¸€è‡´ï¼Œè¯´æ˜é…ç½®åç§°å†™é”™æˆ–æ ¼å¼æœ‰é—®é¢˜"
          echo ""
          
          # ä½¿ç”¨buildozerçš„distcleanç¡®ä¿å¹²å‡€çŠ¶æ€
          # buildozer distclean 2>/dev/null || true
          
          # å°è¯•è·å–Buildozerè¯»å–çš„é…ç½®ï¼ˆé€šè¿‡è§£æspecï¼‰
          python3 << 'EOF'
import configparser
import os

print("=== è§£æ buildozer.spec ===")
config = configparser.ConfigParser()
config.read('buildozer.spec')

# æ£€æŸ¥å…³é”®Androidé…ç½®
android_keys = [
    'android.api',
    'android.minapi', 
    'android.ndk',
    'android.build_tools',
    'android.sdk_path',
    'android.ndk_path',
    'android.archs',
    'android.accept_sdk_license'
]

print("\n[app] sectionä¸­çš„Androidé…ç½®ï¼š")
for key in android_keys:
    try:
        value = config.get('app', key)
        print(f"  âœ“ {key} = {value}")
    except configparser.NoOptionError:
        print(f"  âœ— {key} = NOT FOUND (Buildozerå°†ä½¿ç”¨é»˜è®¤å€¼!)")

# æ£€æŸ¥requirements
try:
    req = config.get('app', 'requirements')
    print(f"\n  âœ“ requirements = {req}")
except:
    print(f"\n  âœ— requirements = NOT FOUND")

print("\n=== é…ç½®éªŒè¯å®Œæˆ ===")
EOF
          
          echo ""
          echo "âœ… Config verification complete!"

      # =========================================
      # æ­¥éª¤14ï¼šã€æ ¸å¿ƒæ­¥éª¤ã€‘æ„å»ºAPK
      # ã€å…³é”®ä¿®å¤â‘ ã€‘è¾“å‡ºè¯¦ç»†æ—¥å¿—åˆ°æ–‡ä»¶
      # =========================================
      - name: Build APK with Buildozer (Verbose)
        id: build
        run: |
          echo "ğŸ”¨ Starting Buildozer build..."
          echo "================================================"
          echo "Build started at: $(date)"
          echo "================================================"
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT
          export ANDROID_HOME=$ANDROID_HOME
          export ANDROID_NDK_HOME=$ANDROID_NDK_HOME
          export PATH="$ANDROID_SDK_ROOT/build-tools/34.0.0:$ANDROID_SDK_ROOT/build-tools/33.0.2:$ANDROID_SDK_ROOT/platform-tools:/usr/local/bin:$PATH"
          
          # æ‰§è¡Œæ„å»ºï¼Œè¾“å‡ºåˆ°æ—¥å¿—æ–‡ä»¶å¹¶åŒæ—¶æ˜¾ç¤º
          # ä½¿ç”¨ set +e å…è®¸å‘½ä»¤å¤±è´¥åç»§ç»­æ‰§è¡Œ
          set +e
          
          buildozer -v android debug 2>&1 | tee buildozer_full.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          
          set -e
          
          echo ""
          echo "================================================"
          echo "Build finished at: $(date)"
          echo "Build exit code: $BUILD_EXIT_CODE"
          echo "================================================"
          
          # ä¿å­˜é€€å‡ºç ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "build_exit_code=$BUILD_EXIT_CODE" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥APKæ˜¯å¦ç”Ÿæˆ
          if ls bin/*.apk 1>/dev/null 2>&1; then
            echo "âœ… APK file(s) found!"
            ls -lh bin/*.apk
            echo "apk_exists=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ No APK files found in bin/"
            echo "apk_exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          BUILDOZER_WARN_ON_ROOT: 0

      # =========================================
      # æ­¥éª¤15ï¼šã€è°ƒè¯•ã€‘æ˜¾ç¤ºæ„å»ºæ—¥å¿—æœ€å500è¡Œ
      # æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ˜¾ç¤º
      # =========================================
      - name: Show Build Log (Last 500 lines)
        if: always()
        run: |
          echo "ğŸ“‹ Build log (last 500 lines):"
          echo "================================================"
          tail -500 buildozer_full.log 2>/dev/null || echo "No build log found"

      # =========================================
      # æ­¥éª¤16ï¼šã€è°ƒè¯•ã€‘æ˜¾ç¤ºé”™è¯¯å…³é”®è¯
      # =========================================
      - name: Search for Errors in Log
        if: always()
        run: |
          echo "ğŸ” Searching for errors in build log..."
          echo ""
          echo "=== Lines containing 'error' ==="
          grep -i "error" buildozer_full.log 2>/dev/null | tail -50 || echo "No 'error' found"
          echo ""
          echo "=== Lines containing 'failed' ==="
          grep -i "failed" buildozer_full.log 2>/dev/null | tail -30 || echo "No 'failed' found"
          echo ""
          echo "=== Lines containing 'exception' ==="
          grep -i "exception" buildozer_full.log 2>/dev/null | tail -20 || echo "No 'exception' found"
          echo ""
          echo "=== Lines containing 'not found' ==="
          grep -i "not found" buildozer_full.log 2>/dev/null | tail -20 || echo "No 'not found' found"
          echo ""
          echo "=== Lines containing 'license' ==="
          grep -i "license" buildozer_full.log 2>/dev/null | tail -10 || echo "No 'license' found"

      # =========================================
      # æ­¥éª¤17ï¼šä¸Šä¼ æ„å»ºæ—¥å¿—ï¼ˆæ— è®ºæˆåŠŸå¤±è´¥ï¼‰
      # =========================================
      - name: Upload Build Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: buildozer-log
          path: buildozer_full.log
          retention-days: 7
          if-no-files-found: ignore

      # =========================================
      # æ­¥éª¤18ï¼šä¸Šä¼ APKï¼ˆä»…å½“APKå­˜åœ¨æ—¶ï¼‰
      # ã€å…³é”®ä¿®å¤â‘¡ã€‘æ·»åŠ æ¡ä»¶åˆ¤æ–­
      # =========================================
      - name: Upload APK artifact
        if: steps.build.outputs.apk_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: teleprompter-apk
          path: bin/*.apk
          retention-days: 30

      # =========================================
      # æ­¥éª¤19ï¼šæ„å»ºç»“æœæ‘˜è¦
      # =========================================
      - name: Build Summary
        if: always()
        run: |
          echo "## ğŸ“± Build Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.build.outputs.apk_exists }}" == "true" ]; then
            echo "### âœ… APK Generated Successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            ls -lh bin/*.apk >> $GITHUB_STEP_SUMMARY 2>/dev/null
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ APK Generation Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Build exit code: ${{ steps.build.outputs.build_exit_code }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Check the uploaded build log for details.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ğŸ” Quick Error Summary" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -i "error\|failed\|exception" buildozer_full.log 2>/dev/null | tail -20 >> $GITHUB_STEP_SUMMARY || echo "See full log" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      # =========================================
      # æ­¥éª¤20ï¼šå¦‚æœæ„å»ºå¤±è´¥åˆ™æŠ¥é”™é€€å‡º
      # =========================================
      - name: Fail if APK not generated
        if: steps.build.outputs.apk_exists != 'true'
        run: |
          echo "âŒ Build failed - APK was not generated"
          echo "Please check the build log artifact for details"
          exit 1
