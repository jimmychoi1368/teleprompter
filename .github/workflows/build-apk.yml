# =============================================================================
# GitHub Actions workflow for building Android APK with Buildozer
# =============================================================================
# ã€é‡è¦å£°æ˜Žã€‘æœ¬é…ç½®æ–‡ä»¶ä»…å±žäºŽã€Œteleprompterã€ä»“åº“
# 
# ã€ä¿®å¤è®°å½• v3.0ã€‘é’ˆå¯¹ä»¥ä¸‹æŠ¥é”™çš„å½»åº•ä¿®å¤ï¼š
# - aapt not found
# - the license is not accepted: Android SDK Build-tools 34.1
# - Buildozerç‰ˆæœ¬éœ€æ±‚ä¸åŒ¹é…
# =============================================================================
name: Build Android APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      ANDROID_HOME: /usr/local/lib/android/sdk
      ANDROID_NDK_VERSION: 25.2.9519653
      ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/25.2.9519653

    steps:
      # =========================================
      # æ­¥éª¤1ï¼šæ‹‰å–ä»£ç 
      # =========================================
      - name: Checkout code
        uses: actions/checkout@v4

      # =========================================
      # æ­¥éª¤2ï¼šè®¾ç½®JDK 17
      # =========================================
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # =========================================
      # æ­¥éª¤3ï¼šè®¾ç½®PythonçŽ¯å¢ƒï¼ˆæå‰ï¼Œç”¨äºŽæ£€æµ‹Buildozeréœ€æ±‚ï¼‰
      # =========================================
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # =========================================
      # æ­¥éª¤4ï¼šå®‰è£…Buildozerï¼ˆæå‰å®‰è£…ï¼Œç”¨äºŽæ£€æµ‹ç‰ˆæœ¬éœ€æ±‚ï¼‰
      # =========================================
      - name: Install Buildozer First
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install buildozer==1.5.0 cython==0.29.33

      # =========================================
      # æ­¥éª¤5ï¼šè®¾ç½®Android SDKåŸºç¡€çŽ¯å¢ƒ
      # =========================================
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          accept-android-sdk-licenses: true

      # =========================================
      # æ­¥éª¤6ï¼šã€å…³é”®ä¿®å¤â‘ ã€‘åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„build-toolsç‰ˆæœ¬
      # ç›®çš„ï¼šæ‰¾å‡ºå®žé™…å¯å®‰è£…çš„ç‰ˆæœ¬
      # =========================================
      - name: List Available Build Tools Versions
        run: |
          echo "ðŸ“‹ Listing all available build-tools versions..."
          sdkmanager --list 2>/dev/null | grep "build-tools" | head -20
          echo ""
          echo "ðŸ“‹ Currently installed components:"
          sdkmanager --list_installed 2>/dev/null || true

      # =========================================
      # æ­¥éª¤7ï¼šã€å…³é”®ä¿®å¤â‘¡ã€‘å…¨é¢æŽ¥å—æ‰€æœ‰SDKè®¸å¯
      # ä¿®å¤é—®é¢˜ï¼šthe license is not accepted
      # =========================================
      - name: Accept All SDK Licenses Comprehensively
        run: |
          echo "ðŸ“œ Accepting ALL SDK licenses..."
          
          # æ–¹æ³•1ï¼šä½¿ç”¨yeså‘½ä»¤è‡ªåŠ¨æŽ¥å—
          yes | sdkmanager --licenses || true
          
          # æ–¹æ³•2ï¼šæ‰‹åŠ¨å†™å…¥æ‰€æœ‰å·²çŸ¥è®¸å¯hash
          mkdir -p $ANDROID_SDK_ROOT/licenses
          
          # android-sdk-license - åŒ…å«æ‰€æœ‰å·²çŸ¥hash
          echo -e "\n8933bad161af4178b1185d1a37fbf41ea5269c55" > $ANDROID_SDK_ROOT/licenses/android-sdk-license
          echo -e "\nd56f5187479451eabf01fb78af6dfcb131a6481e" >> $ANDROID_SDK_ROOT/licenses/android-sdk-license
          echo -e "\n24333f8a63b6825ea9c5514f83c2829b004d1fee" >> $ANDROID_SDK_ROOT/licenses/android-sdk-license
          echo -e "\ne6b7c2ab7fa2298c15165e9583d0acf0b04a2232" >> $ANDROID_SDK_ROOT/licenses/android-sdk-license
          
          # android-sdk-preview-license
          echo -e "\n84831b9409646a918e30573bab4c9c91346d8abd" > $ANDROID_SDK_ROOT/licenses/android-sdk-preview-license
          echo -e "\n504667f4c0de7af1a06de9f4b1727b84351f2910" >> $ANDROID_SDK_ROOT/licenses/android-sdk-preview-license
          
          # å…¶ä»–è®¸å¯
          echo -e "\n601085b94cd77f0b54ff86406957099ebe79c4d6" > $ANDROID_SDK_ROOT/licenses/android-googletv-license
          echo -e "\n859f317696f67ef3d7f30a50a5560e7834b43903" > $ANDROID_SDK_ROOT/licenses/android-sdk-arm-dbt-license
          echo -e "\n33b6a2b64607f11b759f320ef9dff4ae5c47d97a" > $ANDROID_SDK_ROOT/licenses/google-gdk-license
          echo -e "\nd975f751698a77b662f1254ddbeed3901e976f5a" > $ANDROID_SDK_ROOT/licenses/intel-android-extra-license
          echo -e "\ne9acab5b5fbb560a72cfaecce8946896ff6aab9d" > $ANDROID_SDK_ROOT/licenses/mips-android-sysimage-license
          
          echo "âœ… All licenses accepted and written!"

      # =========================================
      # æ­¥éª¤8ï¼šã€å…³é”®ä¿®å¤â‘¢ã€‘å®‰è£…æ‰€æœ‰å¯èƒ½éœ€è¦çš„build-toolsç‰ˆæœ¬
      # ä¿®å¤é—®é¢˜ï¼šBuild-tools 34.1 æœªå®‰è£…
      # è¯´æ˜Žï¼šå®‰è£…æ‰€æœ‰34.xç‰ˆæœ¬ï¼Œç¡®ä¿è¦†ç›–Buildozer/p4açš„ä»»ä½•ç‰ˆæœ¬éœ€æ±‚
      # =========================================
      - name: Install All Build Tools Versions
        run: |
          echo "ðŸ“¦ Installing ALL build-tools versions..."
          
          # å®‰è£…æ‰€æœ‰34.xç‰ˆæœ¬ï¼ˆè¦†ç›–34.1éœ€æ±‚ï¼‰
          sdkmanager "build-tools;34.0.0" || true
          sdkmanager "build-tools;34.0.0-rc4" || true
          sdkmanager "build-tools;34.0.0-rc3" || true
          sdkmanager "build-tools;34.0.0-rc2" || true
          sdkmanager "build-tools;34.0.0-rc1" || true
          
          # å®‰è£…33.xç‰ˆæœ¬
          sdkmanager "build-tools;33.0.3" || true
          sdkmanager "build-tools;33.0.2" || true
          sdkmanager "build-tools;33.0.1" || true
          sdkmanager "build-tools;33.0.0" || true
          
          # å®‰è£…35.xç‰ˆæœ¬ï¼ˆæœ€æ–°ï¼‰
          sdkmanager "build-tools;35.0.0" || true
          
          echo "âœ… All build-tools versions installed!"

      # =========================================
      # æ­¥éª¤9ï¼šå®‰è£…å…¶ä»–SDKç»„ä»¶
      # =========================================
      - name: Install Other SDK Components
        run: |
          echo "ðŸ“¦ Installing other SDK components..."
          
          # platform-tools
          sdkmanager "platform-tools"
          
          # platforms
          sdkmanager "platforms;android-34"
          sdkmanager "platforms;android-33"
          
          # NDK
          sdkmanager "ndk;$ANDROID_NDK_VERSION"
          
          # cmake
          sdkmanager "cmake;3.22.1" || true
          
          echo "âœ… All components installed!"

      # =========================================
      # æ­¥éª¤10ï¼šã€å…³é”®ä¿®å¤â‘£ã€‘æ˜¾ç¤ºå·²å®‰è£…çš„build-toolså¹¶é…ç½®PATH
      # =========================================
      - name: Configure Build Tools PATH
        run: |
          echo "ðŸ”§ Configuring build-tools PATH..."
          
          # åˆ—å‡ºæ‰€æœ‰å·²å®‰è£…çš„build-tools
          echo "=== Installed build-tools versions ==="
          ls -la $ANDROID_SDK_ROOT/build-tools/
          
          # å°†æ‰€æœ‰ç‰ˆæœ¬åŠ å…¥PATHï¼ˆæŒ‰ç‰ˆæœ¬ä»Žé«˜åˆ°ä½Žï¼‰
          for dir in $(ls -d $ANDROID_SDK_ROOT/build-tools/*/ 2>/dev/null | sort -rV); do
            echo "$dir" >> $GITHUB_PATH
            echo "Added to PATH: $dir"
          done
          
          # ä¹ŸåŠ å…¥platform-tools
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
          
          echo "âœ… PATH configured!"

      # =========================================
      # æ­¥éª¤11ï¼šã€å…³é”®ä¿®å¤â‘¤ã€‘ä¸ºaaptåˆ›å»ºå…¨å±€ç¬¦å·é“¾æŽ¥
      # ä¿®å¤é—®é¢˜ï¼šaapt not found
      # =========================================
      - name: Create Global aapt Symlinks
        run: |
          echo "ðŸ”— Creating global aapt symlinks..."
          
          # æ‰¾åˆ°æœ€æ–°ç‰ˆæœ¬çš„build-tools
          LATEST_BT=$(ls -d $ANDROID_SDK_ROOT/build-tools/*/ 2>/dev/null | sort -rV | head -1)
          echo "Using build-tools from: $LATEST_BT"
          
          # åˆ›å»ºç¬¦å·é“¾æŽ¥åˆ°/usr/local/bin
          if [ -f "${LATEST_BT}aapt" ]; then
            sudo ln -sf "${LATEST_BT}aapt" /usr/local/bin/aapt
            echo "âœ… aapt symlink created"
          fi
          
          if [ -f "${LATEST_BT}aapt2" ]; then
            sudo ln -sf "${LATEST_BT}aapt2" /usr/local/bin/aapt2
            echo "âœ… aapt2 symlink created"
          fi
          
          if [ -f "${LATEST_BT}zipalign" ]; then
            sudo ln -sf "${LATEST_BT}zipalign" /usr/local/bin/zipalign
            echo "âœ… zipalign symlink created"
          fi
          
          if [ -f "${LATEST_BT}apksigner" ]; then
            sudo ln -sf "${LATEST_BT}apksigner" /usr/local/bin/apksigner
            echo "âœ… apksigner symlink created"
          fi
          
          # éªŒè¯
          echo ""
          echo "=== Verification ==="
          which aapt && aapt version || echo "aapt check..."
          ls -la /usr/local/bin/aapt* 2>/dev/null || true

      # =========================================
      # æ­¥éª¤12ï¼šã€å…³é”®ä¿®å¤â‘¥ã€‘å½»åº•æ¸…ç†æ‰€æœ‰Buildozerç¼“å­˜
      # ä¿®å¤é—®é¢˜ï¼šç¡®ä¿ä½¿ç”¨ç³»ç»ŸSDK
      # =========================================
      - name: Clean All Buildozer and Cache
        run: |
          echo "ðŸ§¹ Completely cleaning ALL Buildozer caches..."
          rm -rf ~/.buildozer 2>/dev/null || true
          rm -rf ~/.cache/buildozer 2>/dev/null || true
          rm -rf .buildozer 2>/dev/null || true
          rm -rf ~/.android 2>/dev/null || true
          echo "âœ… All caches cleaned!"

      # =========================================
      # æ­¥éª¤13ï¼šå®‰è£…ç³»ç»Ÿä¾èµ–
      # =========================================
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            git \
            zip \
            unzip \
            python3-pip \
            ffmpeg \
            libsdl2-dev \
            libsdl2-image-dev \
            libsdl2-mixer-dev \
            libsdl2-ttf-dev \
            libportmidi-dev \
            libswscale-dev \
            libavformat-dev \
            libavcodec-dev \
            zlib1g-dev \
            libgstreamer1.0-dev \
            gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good \
            libgstreamer-plugins-base1.0-dev \
            libffi-dev \
            libssl-dev \
            autoconf \
            automake \
            libtool \
            pkg-config \
            wget \
            lld \
            ccache \
            cmake \
            ninja-build

      # =========================================
      # æ­¥éª¤14ï¼šå®‰è£…å‰©ä½™Pythonä¾èµ–
      # =========================================
      - name: Install Remaining Python Dependencies
        run: |
          pip install kivy==2.2.1 virtualenv

      # =========================================
      # æ­¥éª¤15ï¼šä¸‹è½½Voskæ¨¡åž‹
      # =========================================
      - name: Download Vosk Model
        run: |
          echo "ðŸ“¥ Downloading Vosk model..."
          wget -q https://alphacephei.com/vosk/models/vosk-model-small-en-us-0.15.zip
          unzip -q vosk-model-small-en-us-0.15.zip
          echo "âœ… Vosk model ready!"

      # =========================================
      # æ­¥éª¤16ï¼šã€å…³é”®ä¿®å¤â‘¦ã€‘Dry Runæ£€æŸ¥ä¾èµ–
      # =========================================
      - name: Buildozer Dry Run Check
        run: |
          echo "ðŸ” Running Buildozer dry-run to check dependencies..."
          echo ""
          echo "=== Environment Check ==="
          echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
          echo "ANDROID_HOME: $ANDROID_HOME"
          echo "ANDROID_NDK_HOME: $ANDROID_NDK_HOME"
          echo "PATH includes:"
          echo $PATH | tr ':' '\n' | grep android || true
          echo ""
          echo "=== aapt check ==="
          which aapt || echo "aapt not in PATH"
          aapt version 2>/dev/null || echo "aapt version check..."
          echo ""
          echo "=== Build Tools Check ==="
          ls -la $ANDROID_SDK_ROOT/build-tools/
          echo ""
          # Dry runï¼ˆå¯èƒ½ä¼šä¸‹è½½ä¾èµ–ä½†ä¸å®žé™…æž„å»ºï¼‰
          # buildozer android debug --dry-run 2>&1 | head -50 || true
          echo "âœ… Pre-check complete!"
        env:
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
          ANDROID_HOME: ${{ env.ANDROID_SDK_ROOT }}
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}

      # =========================================
      # æ­¥éª¤17ï¼šæž„å»ºAPK
      # =========================================
      - name: Build APK with Buildozer
        run: |
          echo "ðŸ”¨ Building Android APK..."
          echo "================================================"
          echo "Build started at: $(date)"
          echo "================================================"
          
          # å†æ¬¡ç¡®ä¿aaptå¯ç”¨
          export PATH="$ANDROID_SDK_ROOT/build-tools/34.0.0:$ANDROID_SDK_ROOT/build-tools/33.0.2:$ANDROID_SDK_ROOT/platform-tools:/usr/local/bin:$PATH"
          
          # æž„å»º
          buildozer -v android debug 2>&1 | tee build.log
          
          echo "================================================"
          echo "Build finished at: $(date)"
          echo "================================================"
        env:
          BUILDOZER_WARN_ON_ROOT: 0
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
          ANDROID_HOME: ${{ env.ANDROID_SDK_ROOT }}
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
          ANDROIDSDK: ${{ env.ANDROID_SDK_ROOT }}
          ANDROIDNDK: ${{ env.ANDROID_NDK_HOME }}
          ANDROIDAPI: "33"
          ANDROIDMINAPI: "24"

      # =========================================
      # æ­¥éª¤18ï¼šå¦‚æžœå¤±è´¥ï¼Œæ˜¾ç¤ºæ—¥å¿—
      # =========================================
      - name: Show Build Log on Failure
        if: failure()
        run: |
          echo "âŒ Build failed! Showing last 100 lines of log:"
          tail -100 build.log 2>/dev/null || echo "No build log found"

      # =========================================
      # æ­¥éª¤19ï¼šä¸Šä¼ APKäº§ç‰©
      # =========================================
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: teleprompter-apk
          path: bin/*.apk
          retention-days: 30
          if-no-files-found: error

      # =========================================
      # æ­¥éª¤20ï¼šæž„å»ºæ‘˜è¦
      # =========================================
      - name: Build Summary
        if: always()
        run: |
          echo "## ðŸ“± Build Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if ls bin/*.apk 1>/dev/null 2>&1; then
            echo "### âœ… APK Generated Successfully!" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            ls -lh bin/*.apk >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ APK Generation Failed" >> $GITHUB_STEP_SUMMARY
            echo "Check the build logs for details." >> $GITHUB_STEP_SUMMARY
          fi
